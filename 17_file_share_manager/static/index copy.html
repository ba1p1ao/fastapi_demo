<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±€åŸŸç½‘æ–‡ä»¶å…±äº«ç³»ç»Ÿ</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:Arial,sans-serif}
        body{background:#f5f5f5;color:#333;line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:20px}
        header{background:#fff;padding:15px 20px;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.1);margin-bottom:20px;display:flex;justify-content:space-between;align-items:center}
        .logo{font-size:24px;font-weight:bold;color:#2c3e50}
        .search-box{flex:1;margin:0 20px;display:flex;align-items:center}
        .search-box input{flex:1;padding:8px 15px;border:1px solid #ddd;border-radius:4px 0 0 4px}
        .search-box button{padding:8px 15px;background:#3498db;color:white;border:1px solid #3498db;border-radius:4px ;cursor:pointer}
        .search-box button:hover{background:#2980b9}
        .upload-section{display: flex;}
        .upload-section input{padding:8px 15px;border:1px solid #ddd;border-radius:4px 0 0 4px}
        .upload-section button{padding:8px 15px;background:#23936f;color:white;border:1px solid #3498db;border-radius:0 4px 4px 0;cursor:pointer}
        .upload-section button:hover{background:#1c736d}
        .auth-buttons a{margin-left:10px;padding:8px 15px;text-decoration:none;border-radius:4px;cursor:pointer}
        .login-btn{background:#3498db;color:white}
        .register-btn{background:#2ecc71;color:white}
        .user-info{display:none}
        .breadcrumb{padding:10px 15px;background:#fff;border-radius:5px;margin-bottom:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .breadcrumb a{color:#3498db;text-decoration:none;margin:0 5px}
        .breadcrumb span{margin:0 5px}
        .file-list{background:#fff;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.1);overflow:hidden}
        table{width:100%;border-collapse:collapse}
        th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #eee}
        th{background:#f8f9fa;cursor:pointer;font-weight:600}
        th:hover{background:#e9ecef}
        .file-icon{width:20px;margin-right:10px}
        .file-name a{color:#333;text-decoration:none}
        .file-name a:hover{color:#3498db}
        .actions a{margin-right:10px;color:#3498db;text-decoration:none;cursor:pointer}
        .actions a:hover{text-decoration:underline}
        .pagination{padding:15px;text-align:center;background:#fff}
        .pagination a{padding:8px 15px;margin:0 5px;background:#f8f9fa;color:#333;text-decoration:none;border-radius:4px}
        .pagination a.active{background:#3498db;color:white}
        .upload-section{margin: 15px 0px;margin-top:20px;padding:15px;background:#fff;border-radius:5px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000}
        .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:5px;width:100%;max-width:1000px;max-height:90vh;overflow:auto}
        .modal-header{margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
        .modal-body input, .modal-body button{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:4px}
        .modal-body button{background:#3498db;color:white;border:none;cursor:pointer}
        .close{float:right;font-size:24px;cursor:pointer}
        .profile-search-box{margin-bottom:15px;display:flex}
        .profile-search-box input{flex:1;padding:8px 15px;border:1px solid #ddd;border-radius:4px 0 0 4px}
        .profile-search-box button{width: 100px;padding:8px 15px;background:#3498db;color:white;border:1px solid #3498db;border-radius:0 4px 4px 0;cursor:pointer}
        .profile-pagination{padding:15px;text-align:center}
        .profile-pagination a{padding:8px 15px;margin:0 5px;background:#f8f9fa;color:#333;text-decoration:none;border-radius:4px}
        .profile-pagination a.active{background:#3498db;color:white}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">æ–‡ä»¶å…±äº«ç³»ç»Ÿ</div>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢æ–‡ä»¶...">
                <button id="search-btn">æœç´¢</button>
            </div>
            <div class="auth-buttons">
                <a class="login-btn" id="login-btn">ç™»å½•</a>
                <a class="register-btn" id="register-btn">æ³¨å†Œ</a>
            </div>
            <div class="user-info" id="user-info">
                <span id="username"></span>
                <a class="profile-btn" id="profile-btn">ä¸ªäººä¸­å¿ƒ</a>
                <a class="logout-btn" id="logout-btn">é€€å‡º</a>
            </div>
        </header>
        <div class="upload-section" id="upload-section">
            <input type="file" id="file-input" multiple>
            <button id="upload-btn", style="margin: 0 auto 0px 10px;">ä¸Šä¼ æ–‡ä»¶</button>
            <button id="create-dir">åˆ›å»ºæ–‡ä»¶å¤¹</button>
        </div>
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" class="home-link">æ ¹ç›®å½•</a>
        </div>

        <div class="file-list">
            <table>
                <thead>
                    <tr>
                        <th data-sort="name">æ–‡ä»¶å <span class="sort-indicator">â†‘</span></th>
                        <th data-sort="size">å¤§å° <span class="sort-indicator"></span></th>
                        <th data-sort="modified">ä¿®æ”¹æ—¶é—´ <span class="sort-indicator"></span></th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="file-list-body">
                    <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination">
            <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>


    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç™»å½•</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="login-username" placeholder="ç”¨æˆ·å">
                <input type="password" id="login-password" placeholder="å¯†ç ">
                <button id="login-submit">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ³¨å†Œ</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="register-username" placeholder="ç”¨æˆ·å">
                <input type="password" id="register-password" placeholder="å¯†ç ">
                <input type="password" id="register-confirm-password" placeholder="ç¡®è®¤å¯†ç ">
                <button id="register-submit">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡† -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ä¸ªäººä¸­å¿ƒ - æˆ‘çš„æ–‡ä»¶</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="profile-search-box">
                    <input type="text" id="profile-search-input" placeholder="æœç´¢æˆ‘çš„æ–‡ä»¶...">
                    <button id="profile-search-btn">æœç´¢</button>
                </div>
                
                <div class="file-list">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="name" class="profile-sort">æ–‡ä»¶å <span class="profile-sort-indicator">â†‘</span></th>
                                <th data-sort="size" class="profile-sort">å¤§å° <span class="profile-sort-indicator"></span></th>
                                <th data-sort="modified" class="profile-sort">ä¿®æ”¹æ—¶é—´ <span class="profile-sort-indicator"></span></th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="profile-file-list-body">
                            <!-- ä¸ªäººæ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="profile-pagination" id="profile-pagination">
                    <!-- ä¸ªäººä¸­å¿ƒåˆ†é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentPath = '/';
        let currentPage = 1;
        let pageSize = 20;
        let sortField = 'name';
        let sortOrder = 'asc';
        let searchQuery = '';
        
        // ä¸ªäººä¸­å¿ƒç›¸å…³å˜é‡
        let profileCurrentPage = 1;
        let profilePageSize = 20;
        let profileSortField = 'name';
        let profileSortOrder = 'asc';
        let profileSearchQuery = '';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            checkLoginStatus();
            bindEvents();
            loadFileList();
            // ç»‘å®šäº‹ä»¶
            
        });

        // ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
        function bindEvents() {
            // ç™»å½•æ³¨å†Œæ¨¡æ€æ¡†
            $('#login-btn').click(showLoginModal);
            $('#register-btn').click(showRegisterModal);
            $('.close').click(closeModals);
            
            // è¡¨å•æäº¤
            $('#login-submit').click(handleLogin);
            $('#register-submit').click(handleRegister);
            
            // æœç´¢
            $('#search-btn').click(handleSearch);
            $('#search-input').keypress(function(e) {
                if (e.which === 13) { // å›è½¦é”®
                    handleSearch();
                }
            });
            
            // ä¸ªäººä¸­å¿ƒæœç´¢
            $('#profile-search-btn').click(handleProfileSearch);
            $('#profile-search-input').keypress(function(e) {
                if (e.which === 13) { // å›è½¦é”®
                    handleProfileSearch();
                }
            });
            
            // æ’åº
            $('th[data-sort]').click(handleSort);
            
            // æ–‡ä»¶æ“ä½œ
            $('#upload-btn').click(handleUpload);
            // åˆ›å»ºæ–‡ä»¶å¤¹
            $('#create-dir').click(function() {
                const newDirName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹å:');
                if (newDirName) {
                    handleCreateDir(newDirName);
                }
            });
            // ç”¨æˆ·æ“ä½œ
            $('#profile-btn').click(showProfileModal);
            $('#logout-btn').click(handleLogout);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            $(window).click(function(event) {
                if ($(event.target).hasClass('modal')) {
                    closeModals();
                }
            });
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            console.log(token)
            if (token) {
                // éªŒè¯tokenæœ‰æ•ˆæ€§
                $.ajax({
                    url: '/api/users/me',
                    type: 'GET',
                    headers: {'Authorization': `Bearer ${token}`},
                    success: function(user) {
                        currentUser = user;
                        updateUIAfterLogin();
                    },
                    error: function() {
                        localStorage.removeItem('token');
                    }
                });
            } else {
                $('#upload-section').hide();
            }
        }

        // ç™»å½•åæ›´æ–°UI
        function updateUIAfterLogin() {
            $('.auth-buttons').hide();
            $('#user-info').show();
            $('#username').text(currentUser.username);
            // å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–å·²ç™»å½•ç”¨æˆ·ï¼Œæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            if (currentUser.is_admin || currentUser.id) {
                $('#upload-section').show();
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            closeModals();
            $('#login-modal').show();
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
        function showRegisterModal() {
            closeModals();
            $('#register-modal').show();
        }

        // æ˜¾ç¤ºä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†
        function showProfileModal() {
            closeModals();
            // é‡ç½®ä¸ªäººä¸­å¿ƒæœç´¢å’Œåˆ†é¡µçŠ¶æ€
            profileCurrentPage = 1;
            profileSearchQuery = '';
            $('#profile-search-input').val('');
            loadUserFiles();
            $('#profile-modal').show();
            
            // ç»‘å®šä¸ªäººä¸­å¿ƒæ’åºäº‹ä»¶
            $('.profile-sort').off('click').click(handleProfileSort);
        }

        // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
        function closeModals() {
            $('.modal').hide();
        }

        // å¤„ç†ç™»å½•
        function handleLogin() {
            const username = $('#login-username').val();
            const password = $('#login-password').val();
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            $.ajax({
                url: '/api/auth/login',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({username, password}),
                success: function(response) {
                    localStorage.setItem('token', response.access_token);
                    currentUser = response.user;
                    updateUIAfterLogin();
                    closeModals();
                    loadFileList();
                },
                error: function(xhr) {
                    alert('ç™»å½•å¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // å¤„ç†æ³¨å†Œ
        function handleRegister() {
            const username = $('#register-username').val();
            const password = $('#register-password').val();
            const confirmPassword = $('#register-confirm-password').val();
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            $.ajax({
                url: '/api/auth/register',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({username, password}),
                success: function() {
                    alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    closeModals();
                    showLoginModal();
                },
                error: function(xhr) {
                    alert('æ³¨å†Œå¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // å¤„ç†é€€å‡º
        function handleLogout() {
            localStorage.removeItem('token');
            currentUser = null;
            $('.auth-buttons').show();
            $('#user-info').hide();
            $('#upload-section').hide();
            loadFileList();
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFileList() {
            const params = {
                path: currentPath,
                page: currentPage,
                page_size: pageSize,
                sort: sortField,
                order: sortOrder
            };
            
            if (searchQuery) {
                params.q = searchQuery;
            }
            
            $.ajax({
                url: '/api/files/',
                type: 'GET',
                data: params,
                success: function(response) {
                    renderFileList(response.files);
                    renderBreadcrumb(response.path);
                    renderPagination(response.total, response.page, response.pages);
                },
                error: function(xhr) {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', xhr);
                }
            });
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList(files) {
            const $fileListBody = $('#file-list-body');
            $fileListBody.empty();
            
            if (files.length === 0) {
                $fileListBody.append('<tr><td colspan="4" style="text-align:center;">æš‚æ— æ–‡ä»¶</td></tr>');
                return;
            }
            
            files.forEach(file => {
                const icon = getFileIcon(file);
                const size = file.is_directory ? '-' : formatFileSize(file.size);
                const modified = formatDate(file.modified_time);
                
                let actions = '';
                if (currentUser) {
                    if (currentUser.is_admin || file.owner_id === currentUser.id) {
                        actions = `<a class="rename-btn" data-id="${file.id}">é‡å‘½å</a>
                                  <a class="delete-btn" data-id="${file.id}">åˆ é™¤</a>`;
                    }
                }
                if (!file.is_directory) {
                    actions += `<a href="/api/files/${file.id}/download" class="download-btn">ä¸‹è½½</a>`;
                }
                    
                
                const $row = $(`
                    <tr>
                        <td class="file-name">
                            ${icon}
                            ${file.is_directory ? 
                                `<a href="#" class="dir-link" data-path="${file.path}">${file.name}</a>` :
                                `<a href="/api/files/${file.id}/download" target="_blank">${file.name}</a>`
                            }
                        </td>
                        <td>${size}</td>
                        <td>${modified}</td>
                        <td class="actions">${actions}</td>
                    </tr>
                `);
                
                $fileListBody.append($row);
            });
            
            // ç»‘å®šæ–‡ä»¶æ“ä½œäº‹ä»¶
            $('.dir-link').click(function(e) {
                e.preventDefault();
                currentPath = $(this).data('path');
                currentPage = 1;
                loadFileList();
            });
            
            $('.delete-btn').click(function() {
                const fileId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    deleteFile(fileId);
                }
            });
            
            $('.rename-btn').click(function() {
                const fileId = $(this).data('id');
                const newName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å:');
                
                if (newName) {
                    renameFile(fileId, newName);
                }
            });


        }

        // æ¸²æŸ“é¢åŒ…å±‘å¯¼èˆª
        function renderBreadcrumb(path) {
            const $breadcrumb = $('#breadcrumb');
            $breadcrumb.empty();
            
            // æ·»åŠ è¿”å›ä¸Šä¸€çº§
            if (path !== '/') {
                $breadcrumb.append('<a href="#" class="parent-link">è¿”å›ä¸Šä¸€çº§</a>');
            }
            
            // æ·»åŠ æ ¹ç›®å½•
            $breadcrumb.append('<a href="#" class="home-link">æ ¹ç›®å½•</a>');
            
            // æ·»åŠ è·¯å¾„å„éƒ¨åˆ†
            if (path !== '/') {
                const parts = path.split('/').filter(p => p);
                let currentPath = '';
                
                parts.forEach(part => {
                    currentPath += '/' + part;
                    $breadcrumb.append(`<span>/</span><a href="#" class="path-link" data-path="${currentPath}">${part}</a>`);
                });
            }
            
            // ç»‘å®šé¢åŒ…å±‘äº‹ä»¶
            $('.home-link').click(function(e) {
                e.preventDefault();
                currentPath = '/';
                currentPage = 1;
                searchQuery = '';
                loadFileList();
            });
            
            $('.parent-link').click(function(e) {
                e.preventDefault();
                const parts = currentPath.split('/').filter(p => p);
                parts.pop();
                currentPath = '/' + parts.join('/');
                if (currentPath === '') currentPath = '/';
                currentPage = 1;
                loadFileList();
            });
            
            $('.path-link').click(function(e) {
                e.preventDefault();
                currentPath = $(this).data('path');
                currentPage = 1;
                loadFileList();
            });
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(total, page, pages) {
            const $pagination = $('#pagination');
            $pagination.empty();
            
            if (pages <= 1) return;
            
            // ä¸Šä¸€é¡µ
            if (page > 1) {
                $pagination.append(`<a href="#" class="page-link" data-page="${page - 1}">ä¸Šä¸€é¡µ</a>`);
            }
            
            // é¡µç 
            for (let i = 1; i <= pages; i++) {
                if (i === page) {
                    $pagination.append(`<a href="#" class="page-link active" data-page="${i}">${i}</a>`);
                } else {
                    $pagination.append(`<a href="#" class="page-link" data-page="${i}">${i}</a>`);
                }
            }
            
            // ä¸‹ä¸€é¡µ
            if (page < pages) {
                $pagination.append(`<a href="#" class="page-link" data-page="${page + 1}">ä¸‹ä¸€é¡µ</a>`);
            }
            
            // ç»‘å®šåˆ†é¡µäº‹ä»¶
            $('.page-link').click(function(e) {
                e.preventDefault();
                currentPage = $(this).data('page');
                loadFileList();
            });
        }

        // å¤„ç†æœç´¢
        function handleSearch() {
            searchQuery = $('#search-input').val();
            currentPage = 1;
            loadFileList();
            searchQuery = '';
        }

        // å¤„ç†æ’åº
        function handleSort() {
            const field = $(this).data('sort');
            
            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            $('.sort-indicator').text('');
            if (sortField === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortOrder = 'asc';
            }
            $(this).find('.sort-indicator').text(sortOrder === 'asc' ? 'â†‘' : 'â†“');
            
            currentPage = 1;
            loadFileList();
        }
        
        
        function handleCreateDir(dirName){
            console.log(currentPath)
            $.ajax({
                url: `/api/files/dir`,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                data: JSON.stringify({
                    dirname: dirName,
                    path: currentPath
                }),
                success: function() {
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                    loadFileList();
                    // å¦‚æœä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸ªäººä¸­å¿ƒæ–‡ä»¶åˆ—è¡¨
                    if ($('#profile-modal').is(':visible')) {
                        loadUserFiles();
                    }
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleUpload() {
            const files = $('#file-input')[0].files;
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
            }
            formData.append('path', currentPath);
            
            $.ajax({
                url: '/api/files/upload',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                success: function() {
                    alert('æ–‡ä»¶ä¸Šä¼ æˆåŠŸ');
                    $('#file-input').val('');
                    loadFileList();
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶ä¸Šä¼ å¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // åˆ é™¤æ–‡ä»¶
        function deleteFile(fileId) {
            $.ajax({
                url: `/api/files/${fileId}`,
                type: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                success: function() {
                    alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                    loadFileList();
                    // å¦‚æœä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸ªäººä¸­å¿ƒæ–‡ä»¶åˆ—è¡¨
                    if ($('#profile-modal').is(':visible')) {
                        loadUserFiles();
                    }
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶åˆ é™¤å¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // é‡å‘½åæ–‡ä»¶
        function renameFile(fileId, newName) {
            $.ajax({
                url: `/api/files/${fileId}`,
                type: 'PUT',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                data: JSON.stringify({name: newName}),
                success: function() {
                    alert('æ–‡ä»¶é‡å‘½åæˆåŠŸ');
                    loadFileList();
                    // å¦‚æœä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸ªäººä¸­å¿ƒæ–‡ä»¶åˆ—è¡¨
                    if ($('#profile-modal').is(':visible')) {
                        loadUserFiles();
                    }
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶é‡å‘½åå¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // åŠ è½½ç”¨æˆ·æ–‡ä»¶
        function loadUserFiles() {
            const params = {
                page: profileCurrentPage,
                page_size: profilePageSize,
                sort: profileSortField,
                order: profileSortOrder
            };
            
            if (profileSearchQuery) {
                params.q = profileSearchQuery;
            }
            
            $.ajax({
                url: '/api/users/me/files',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                data: params,
                success: function(response) {
                    renderUserFiles(response.files);
                    renderProfilePagination(response.total, response.page, response.pages);
                },
                error: function(xhr) {
                    console.error('åŠ è½½ç”¨æˆ·æ–‡ä»¶å¤±è´¥:', xhr);
                }
            });
        }

        // æ¸²æŸ“ç”¨æˆ·æ–‡ä»¶
        function renderUserFiles(files) {
            const $profileFileListBody = $('#profile-file-list-body');
            $profileFileListBody.empty();
            
            if (files.length === 0) {
                $profileFileListBody.append('<tr><td colspan="4" style="text-align:center;">æš‚æ— æ–‡ä»¶</td></tr>');
                return;
            }
            
            files.forEach(file => {
                const icon = getFileIcon(file);
                const size = file.is_directory ? '-' : formatFileSize(file.size);
                const modified = formatDate(file.modified_time);
                
                const $row = $(`
                    <tr>
                        <td class="file-name">
                            ${icon}
                            <a href="/api/files/${file.id}/download" target="_blank">${file.name}</a>
                        </td>
                        <td>${size}</td>
                        <td>${modified}</td>
                        <td class="actions">
                            <a class="rename-btn" data-id="${file.id}">é‡å‘½å</a>
                            <a class="delete-btn" data-id="${file.id}">åˆ é™¤</a>
                            <a href="/api/files/${file.id}/download" class="download-btn">ä¸‹è½½</a>
                        </td>
                    </tr>
                `);
                
                $profileFileListBody.append($row);
            });
            
            // ç»‘å®šä¸ªäººä¸­å¿ƒæ–‡ä»¶æ“ä½œäº‹ä»¶
            $profileFileListBody.find('.delete-btn').click(function() {
                const fileId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    deleteFile(fileId);
                }
            });
            
            $profileFileListBody.find('.rename-btn').click(function() {
                const fileId = $(this).data('id');
                const newName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å:');
                if (newName) {
                    renameFile(fileId, newName);
                }
            });
        }

        // æ¸²æŸ“ä¸ªäººä¸­å¿ƒåˆ†é¡µ
        function renderProfilePagination(total, page, pages) {
            const $profilePagination = $('#profile-pagination');
            $profilePagination.empty();
            
            if (pages <= 1) return;
            
            // ä¸Šä¸€é¡µ
            if (page > 1) {
                $profilePagination.append(`<a href="#" class="profile-page-link" data-page="${page - 1}">ä¸Šä¸€é¡µ</a>`);
            }
            
            // é¡µç 
            for (let i = 1; i <= pages; i++) {
                if (i === page) {
                    $profilePagination.append(`<a href="#" class="profile-page-link active" data-page="${i}">${i}</a>`);
                } else {
                    $profilePagination.append(`<a href="#" class="profile-page-link" data-page="${i}">${i}</a>`);
                }
            }
            
            // ä¸‹ä¸€é¡µ
            if (page < pages) {
                $profilePagination.append(`<a href="#" class="profile-page-link" data-page="${page + 1}">ä¸‹ä¸€é¡µ</a>`);
            }
            
            // ç»‘å®šä¸ªäººä¸­å¿ƒåˆ†é¡µäº‹ä»¶
            $('.profile-page-link').click(function(e) {
                e.preventDefault();
                profileCurrentPage = $(this).data('page');
                loadUserFiles();
            });
        }

        // å¤„ç†ä¸ªäººä¸­å¿ƒæœç´¢
        function handleProfileSearch() {
            profileSearchQuery = $('#profile-search-input').val();
            profileCurrentPage = 1;
            loadUserFiles();
        }

        // å¤„ç†ä¸ªäººä¸­å¿ƒæ’åº
        function handleProfileSort() {
            const field = $(this).data('sort');
            
            // æ›´æ–°ä¸ªäººä¸­å¿ƒæ’åºæŒ‡ç¤ºå™¨
            $('.profile-sort-indicator').text('');
            if (profileSortField === field) {
                profileSortOrder = profileSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                profileSortField = field;
                profileSortOrder = 'asc';
            }
            $(this).find('.profile-sort-indicator').text(profileSortOrder === 'asc' ? 'â†‘' : 'â†“');
            
            profileCurrentPage = 1;
            loadUserFiles();
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(file) {
            if (file.is_directory) {
                return 'ğŸ“';
            }
            
            const ext = file.name.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'ğŸ“•',
                'zip': 'ğŸ“¦',
                'rar': 'ğŸ“¦',
                '7z': 'ğŸ“¦',
                'jpg': 'ğŸ–¼ï¸',
                'jpeg': 'ğŸ–¼ï¸',
                'png': 'ğŸ–¼ï¸',
                'gif': 'ğŸ–¼ï¸',
                'txt': 'ğŸ“„',
                'doc': 'ğŸ“„',
                'docx': 'ğŸ“„',
                'xls': 'ğŸ“Š',
                'xlsx': 'ğŸ“Š',
                'ppt': 'ğŸ“½ï¸',
                'pptx': 'ğŸ“½ï¸'
            };
            
            return iconMap[ext] || 'ğŸ“„';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
    </script>
</body>
</html>
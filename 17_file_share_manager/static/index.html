<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å±€åŸŸç½‘æ–‡ä»¶å…±äº«ç³»ç»Ÿ</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI', Arial, sans-serif}
        body{background:#f5f7fa;color:#333;line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:15px}
        header{background:#fff;padding:15px 20px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.08);margin-bottom:20px;display:flex;flex-wrap:wrap;justify-content:space-between;align-items:center}
        .logo{font-size:24px;font-weight:bold;color:#2c3e50;display:flex;align-items:center}
        .logo:before{content:"ğŸ“";margin-right:8px}
        .search-box{flex:1;margin:10px 20px;display:flex;align-items:center;min-width:200px}
        .search-box input{flex:1;padding:10px 15px;border:1px solid #ddd;border-radius:6px 0 0 6px;font-size:14px;transition:border-color 0.3s}
        .search-box input:focus{outline:none;border-color:#3498db}
        .search-box button{padding:10px 15px;background:#3498db;color:white;border:1px solid #3498db;border-radius:0 6px 6px 0;cursor:pointer;font-weight:500;transition:background 0.3s}
        .search-box button:hover{background:#2980b9}
        .auth-buttons{display:flex;gap:10px}
        .auth-buttons a{padding:8px 15px;text-decoration:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.3s;font-size:14px}
        .login-btn{background:#3498db;color:white}
        .login-btn:hover{background:#2980b9;transform:translateY(-2px)}
        .register-btn{background:#2ecc71;color:white}
        .register-btn:hover{background:#27ae60;transform:translateY(-2px)}
        .user-info{display:none;align-items:center;gap:15px}
        .user-info span{font-weight:500}
        .user-info a{padding:8px 15px;text-decoration:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.3s;font-size:14px}
        .profile-btn{background:#9b59b6;color:white}
        .profile-btn:hover{background:#8e44ad;transform:translateY(-2px)}
        .logout-btn{background:#e74c3c;color:white}
        .logout-btn:hover{background:#c0392b;transform:translateY(-2px)}
        .upload-section{display:flex;flex-wrap:wrap;gap:10px;margin:20px 0;padding:15px;background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
        .upload-section input{flex:1;min-width:200px;padding:10px 15px;border:1px solid #ddd;border-radius:6px;font-size:14px}
        .upload-section button{padding:10px 15px;background:#23936f;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:500;transition:all 0.3s}
        .upload-section button:hover{background:#1c736d;transform:translateY(-2px)}
        .breadcrumb{padding:12px 15px;background:#fff;border-radius:8px;margin-bottom:20px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow-x:auto;white-space:nowrap}
        .breadcrumb a{color:#3498db;text-decoration:none;margin:0 5px;transition:color 0.3s}
        .breadcrumb a:hover{color:#2980b9}
        .breadcrumb span{margin:0 5px;color:#7f8c8d}
        .file-list{background:#fff;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.08);overflow:hidden;overflow-x:auto}
        table{width:100%;border-collapse:collapse;min-width:600px}
        th,td{padding:12px 15px;text-align:left;border-bottom:1px solid #eee}
        th{background:#f8f9fa;cursor:pointer;font-weight:600;position:sticky;top:0}
        th:hover{background:#e9ecef}
        .file-icon{width:20px;margin-right:10px}
        .file-name a{color:#333;text-decoration:none;transition:color 0.3s}
        .file-name a:hover{color:#3498db}
        .actions{display:flex;gap:8px;flex-wrap:wrap}
        .actions a{padding:4px 8px;color:#3498db;text-decoration:none;cursor:pointer;border-radius:4px;transition:all 0.3s;font-size:13px}
        .actions a:hover{background:#f1f8ff;text-decoration:none}
        .pagination{padding:15px;text-align:center;background:#fff;border-radius:0 0 8px 8px;box-shadow:0 2px 10px rgba(0,0,0,0.08);display:flex;justify-content:center;flex-wrap:wrap;gap:5px}
        .pagination a{padding:8px 12px;background:#f8f9fa;color:#333;text-decoration:none;border-radius:6px;transition:all 0.3s;font-size:14px}
        .pagination a:hover{background:#e9ecef}
        .pagination a.active{background:#3498db;color:white}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;overflow-y:auto;padding:20px}
        .modal-content{position:relative;background:#fff;padding:20px;border-radius:8px;width:100%;max-width:800px;margin:0 auto;box-shadow:0 5px 15px rgba(0,0,0,0.2)}
        .modal-header{margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
        .modal-body input, .modal-body button{width:100%;padding:10px;margin-bottom:10px;border:1px solid #ddd;border-radius:6px;font-size:14px}
        .modal-body input:focus{outline:none;border-color:#3498db}
        .modal-body button{background:#3498db;color:white;border:none;cursor:pointer;font-weight:500;transition:background 0.3s}
        .modal-body button:hover{background:#2980b9}
        .close{font-size:24px;cursor:pointer;color:#7f8c8d;transition:color 0.3s}
        .close:hover{color:#333}
        .profile-search-box{margin-bottom:15px;display:flex;gap:10px}
        .profile-search-box input{flex:1;padding:10px 15px;border:1px solid #ddd;border-radius:6px;font-size:14px}
        .profile-search-box button{width: 30%;padding:10px 15px;background:#3498db;color:white;border:1px solid #3498db;border-radius:6px;cursor:pointer;font-weight:500;transition:background 0.3s}
        .profile-search-box button:hover{background:#2980b9}
        .profile-pagination{padding:15px;text-align:center;display:flex;justify-content:center;flex-wrap:wrap;gap:5px}
        .profile-pagination a{padding:8px 12px;background:#f8f9fa;color:#333;text-decoration:none;border-radius:6px;transition:all 0.3s;font-size:14px}
        .profile-pagination a:hover{background:#e9ecef}
        .profile-pagination a.active{background:#3498db;color:white}
        
        /* ä¸Šä¼ è¿›åº¦æ¡æ ·å¼ */
        .upload-progress-container {
            width: 100%;
            margin-top: 15px;
            display: none;
        }
        
        .upload-progress-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        
        .upload-progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #23936f, #2ecc71);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .upload-speed {
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .upload-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .upload-cancel-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .upload-cancel-btn:hover {
            background: #c0392b;
        }
        
        /* ç§»åŠ¨ç«¯ä¼˜åŒ– */
        @media (max-width: 768px) {
            .container{padding:10px}
            header{flex-direction:column;align-items:stretch;gap:15px}
            .logo{justify-content:center}
            .search-box{margin:0;order:3}
            .auth-buttons, .user-info{justify-content:center}
            .upload-section{flex-direction:column}
            .upload-section input, .upload-section button{width:100%}
            th, td{padding:10px 8px;font-size:14px}
            .file-name a{word-break:break-word}
            .modal-content{padding:15px;margin:10px}
            .profile-search-box{flex-direction:row}
            .actions{justify-content:center}
        }
        
        @media (max-width: 480px) {
            .breadcrumb{font-size:14px}
            th, td{padding:8px 5px;font-size:13px}
            .pagination a, .profile-pagination a{padding:6px 10px;font-size:13px}
            .auth-buttons a, .user-info a{padding:6px 12px;font-size:13px}
        }
        
        /* æ–‡ä»¶ç±»å‹å›¾æ ‡é¢œè‰² */
        .file-icon-folder{color:#f39c12}
        .file-icon-image{color:#e74c3c}
        .file-icon-document{color:#3498db}
        .file-icon-audio{color:#9b59b6}
        .file-icon-video{color:#e67e22}
        .file-icon-archive{color:#95a5a6}
        .file-icon-other{color:#7f8c8d}
        
        /* åŠ è½½åŠ¨ç”» */
        .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">æ–‡ä»¶å…±äº«ç³»ç»Ÿ</div>
            <div class="search-box">
                <input type="text" id="search-input" placeholder="æœç´¢æ–‡ä»¶...">
                <button id="search-btn">æœç´¢</button>
            </div>
            <div class="auth-buttons">
                <a class="login-btn" id="login-btn">ç™»å½•</a>
                <a class="register-btn" id="register-btn">æ³¨å†Œ</a>
            </div>
            <div class="user-info" id="user-info">
                <span id="username"></span>
                <a class="profile-btn" id="profile-btn">ä¸ªäººä¸­å¿ƒ</a>
                <a class="logout-btn" id="logout-btn">é€€å‡º</a>
            </div>
        </header>
        
        <div class="upload-section" id="upload-section">
            <input type="file" id="file-input" multiple>
            <button id="upload-btn">ä¸Šä¼ æ–‡ä»¶</button>
            <button id="create-dir">åˆ›å»ºæ–‡ä»¶å¤¹</button>
            
            <!-- ä¸Šä¼ è¿›åº¦æ¡ -->
            <div class="upload-progress-container" id="upload-progress-container">
                <div class="upload-progress-info">
                    <span id="upload-file-name">æ­£åœ¨ä¸Šä¼ : æ–‡ä»¶å</span>
                    <span id="upload-percentage">0%</span>
                </div>
                <div class="upload-progress-bar">
                    <div class="upload-progress-fill" id="upload-progress-fill"></div>
                </div>
                <div class="upload-progress-info">
                    <span id="upload-status-text">å‡†å¤‡ä¸Šä¼ ...</span>
                    <div class="upload-status">
                        <span class="upload-speed" id="upload-speed">0 KB/s</span>
                        <button class="upload-cancel-btn" id="upload-cancel-btn">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="breadcrumb" id="breadcrumb">
            <a href="#" class="home-link">æ ¹ç›®å½•</a>
        </div>

        <div class="file-list">
            <table>
                <thead>
                    <tr>
                        <th data-sort="name">æ–‡ä»¶å <span class="sort-indicator">â†‘</span></th>
                        <th data-sort="size">å¤§å° <span class="sort-indicator"></span></th>
                        <th data-sort="modified">ä¿®æ”¹æ—¶é—´ <span class="sort-indicator"></span></th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="file-list-body">
                    <!-- æ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </tbody>
            </table>
        </div>

        <div class="pagination" id="pagination">
            <!-- åˆ†é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ç™»å½•</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="login-username" placeholder="ç”¨æˆ·å">
                <input type="password" id="login-password" placeholder="å¯†ç ">
                <button id="login-submit">ç™»å½•</button>
            </div>
        </div>
    </div>

    <!-- æ³¨å†Œæ¨¡æ€æ¡† -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>æ³¨å†Œ</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <input type="text" id="register-username" placeholder="ç”¨æˆ·å">
                <input type="password" id="register-password" placeholder="å¯†ç ">
                <input type="password" id="register-confirm-password" placeholder="ç¡®è®¤å¯†ç ">
                <button id="register-submit">æ³¨å†Œ</button>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡† -->
    <div class="modal" id="profile-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ä¸ªäººä¸­å¿ƒ - æˆ‘çš„æ–‡ä»¶</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="profile-search-box">
                    <input type="text" id="profile-search-input" placeholder="æœç´¢æˆ‘çš„æ–‡ä»¶...">
                    <button id="profile-search-btn">æœç´¢</button>
                </div>
                
                <div class="file-list">
                    <table>
                        <thead>
                            <tr>
                                <th data-sort="name" class="profile-sort">æ–‡ä»¶å <span class="profile-sort-indicator">â†‘</span></th>
                                <th data-sort="size" class="profile-sort">å¤§å° <span class="profile-sort-indicator"></span></th>
                                <th data-sort="modified" class="profile-sort">ä¿®æ”¹æ—¶é—´ <span class="profile-sort-indicator"></span></th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="profile-file-list-body">
                            <!-- ä¸ªäººæ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                </div>
                
                <div class="profile-pagination" id="profile-pagination">
                    <!-- ä¸ªäººä¸­å¿ƒåˆ†é¡µå°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentUser = null;
        let currentPath = '/';
        let currentPage = 1;
        let pageSize = 20;
        let sortField = 'name';
        let sortOrder = 'asc';
        let searchQuery = '';
        
        // ä¸ªäººä¸­å¿ƒç›¸å…³å˜é‡
        let profileCurrentPage = 1;
        let profilePageSize = 20;
        let profileSortField = 'name';
        let profileSortOrder = 'asc';
        let profileSearchQuery = '';
        
        // ä¸Šä¼ ç›¸å…³å˜é‡
        let uploadStartTime = 0;
        let uploadXHR = null;
        let uploadProgressInterval = null;

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function() {
            checkLoginStatus();
            bindEvents();
            loadFileList();
        });

        // ç»‘å®šäº‹ä»¶å¤„ç†å‡½æ•°
        function bindEvents() {
            // ç™»å½•æ³¨å†Œæ¨¡æ€æ¡†
            $('#login-btn').click(showLoginModal);
            $('#register-btn').click(showRegisterModal);
            $('.close').click(closeModals);
            
            // è¡¨å•æäº¤
            $('#login-submit').click(handleLogin);
            $('#register-submit').click(handleRegister);
            
            // æœç´¢
            $('#search-btn').click(handleSearch);
            $('#search-input').keypress(function(e) {
                if (e.which === 13) { // å›è½¦é”®
                    handleSearch();
                }
            });
            
            // ä¸ªäººä¸­å¿ƒæœç´¢
            $('#profile-search-btn').click(handleProfileSearch);
            $('#profile-search-input').keypress(function(e) {
                if (e.which === 13) { // å›è½¦é”®
                    handleProfileSearch();
                }
            });
            
            // æ’åº
            $('th[data-sort]').click(handleSort);
            
            // æ–‡ä»¶æ“ä½œ
            $('#upload-btn').click(handleUpload);
            // åˆ›å»ºæ–‡ä»¶å¤¹
            $('#create-dir').click(function() {
                const newDirName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å¤¹å:');
                if (newDirName) {
                    handleCreateDir(newDirName);
                }
            });
            // ç”¨æˆ·æ“ä½œ
            $('#profile-btn').click(showProfileModal);
            $('#logout-btn').click(handleLogout);
            
            // ä¸Šä¼ å–æ¶ˆæŒ‰é’®
            $('#upload-cancel-btn').click(cancelUpload);
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            $(window).click(function(event) {
                if ($(event.target).hasClass('modal')) {
                    closeModals();
                }
            });
        }

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkLoginStatus() {
            const token = localStorage.getItem('token');
            if (token) {
                // éªŒè¯tokenæœ‰æ•ˆæ€§
                $.ajax({
                    url: '/api/users/me',
                    type: 'GET',
                    headers: {'Authorization': `Bearer ${token}`},
                    success: function(user) {
                        currentUser = user;
                        updateUIAfterLogin();
                    },
                    error: function() {
                        localStorage.removeItem('token');
                    }
                });
            } else {
                $('#upload-section').hide();
            }
        }

        // ç™»å½•åæ›´æ–°UI
        function updateUIAfterLogin() {
            $('.auth-buttons').hide();
            $('#user-info').show();
            $('#username').text(currentUser.username);
            // å¦‚æœæ˜¯ç®¡ç†å‘˜æˆ–å·²ç™»å½•ç”¨æˆ·ï¼Œæ˜¾ç¤ºä¸Šä¼ åŒºåŸŸ
            if (currentUser.is_admin || currentUser.id) {
                $('#upload-section').show();
            }
        }

        // æ˜¾ç¤ºç™»å½•æ¨¡æ€æ¡†
        function showLoginModal() {
            closeModals();
            $('#login-modal').show();
        }

        // æ˜¾ç¤ºæ³¨å†Œæ¨¡æ€æ¡†
        function showRegisterModal() {
            closeModals();
            $('#register-modal').show();
        }

        // æ˜¾ç¤ºä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†
        function showProfileModal() {
            closeModals();
            // é‡ç½®ä¸ªäººä¸­å¿ƒæœç´¢å’Œåˆ†é¡µçŠ¶æ€
            profileCurrentPage = 1;
            profileSearchQuery = '';
            $('#profile-search-input').val('');
            loadUserFiles();
            $('#profile-modal').show();
            
            // ç»‘å®šä¸ªäººä¸­å¿ƒæ’åºäº‹ä»¶
            $('.profile-sort').off('click').click(handleProfileSort);
        }

        // å…³é—­æ‰€æœ‰æ¨¡æ€æ¡†
        function closeModals() {
            $('.modal').hide();
        }

        // å¤„ç†ç™»å½•
        function handleLogin() {
            const username = $('#login-username').val();
            const password = $('#login-password').val();
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            $.ajax({
                url: '/api/auth/login',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({username, password}),
                success: function(response) {
                    localStorage.setItem('token', response.access_token);
                    currentUser = response.user;
                    updateUIAfterLogin();
                    closeModals();
                    loadFileList();
                },
                error: function(xhr) {
                    alert('ç™»å½•å¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // å¤„ç†æ³¨å†Œ
        function handleRegister() {
            const username = $('#register-username').val();
            const password = $('#register-password').val();
            const confirmPassword = $('#register-confirm-password').val();
            
            if (!username || !password) {
                alert('è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ');
                return;
            }
            
            if (password !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            $.ajax({
                url: '/api/auth/register',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({username, password}),
                success: function() {
                    alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                    closeModals();
                    showLoginModal();
                },
                error: function(xhr) {
                    alert('æ³¨å†Œå¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // å¤„ç†é€€å‡º
        function handleLogout() {
            localStorage.removeItem('token');
            currentUser = null;
            $('.auth-buttons').show();
            $('#user-info').hide();
            $('#upload-section').hide();
            loadFileList();
        }

        // åŠ è½½æ–‡ä»¶åˆ—è¡¨
        function loadFileList() {
            const params = {
                path: currentPath,
                page: currentPage,
                page_size: pageSize,
                sort: sortField,
                order: sortOrder
            };
            
            if (searchQuery) {
                params.q = searchQuery;
            }
            
            $.ajax({
                url: '/api/files/',
                type: 'GET',
                data: params,
                success: function(response) {
                    renderFileList(response.files);
                    renderBreadcrumb(response.path);
                    renderPagination(response.total, response.page, response.pages);
                },
                error: function(xhr) {
                    console.error('åŠ è½½æ–‡ä»¶åˆ—è¡¨å¤±è´¥:', xhr);
                }
            });
        }

        // æ¸²æŸ“æ–‡ä»¶åˆ—è¡¨
        function renderFileList(files) {
            const $fileListBody = $('#file-list-body');
            $fileListBody.empty();
            
            if (files.length === 0) {
                $fileListBody.append('<tr><td colspan="4" style="text-align:center;">æš‚æ— æ–‡ä»¶</td></tr>');
                return;
            }
            
            files.forEach(file => {
                const icon = getFileIcon(file);
                const size = file.is_directory ? '-' : formatFileSize(file.size);
                const modified = formatDate(file.modified_time);
                
                let actions = '';
                if (currentUser) {
                    if (currentUser.is_admin || file.owner_id === currentUser.id) {
                        actions = `<a class="rename-btn" data-id="${file.id}">é‡å‘½å</a>
                                  <a class="delete-btn" data-id="${file.id}">åˆ é™¤</a>`;
                    }
                }
                if (!file.is_directory) {
                    actions += `<a href="/api/files/${file.id}/download" class="download-btn">ä¸‹è½½</a>`;
                }
                    
                
                const $row = $(`
                    <tr>
                        <td class="file-name">
                            ${icon}
                            ${file.is_directory ? 
                                `<a href="#" class="dir-link" data-path="${file.path}">${file.name}</a>` :
                                `<a href="/api/files/${file.id}/download" target="_blank">${file.name}</a>`
                            }
                        </td>
                        <td>${size}</td>
                        <td>${modified}</td>
                        <td class="actions">${actions}</td>
                    </tr>
                `);
                
                $fileListBody.append($row);
            });
            
            // ç»‘å®šæ–‡ä»¶æ“ä½œäº‹ä»¶
            $('.dir-link').click(function(e) {
                e.preventDefault();
                currentPath = $(this).data('path');
                currentPage = 1;
                loadFileList();
            });
            
            $('.delete-btn').click(function() {
                const fileId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    deleteFile(fileId);
                }
            });
            
            $('.rename-btn').click(function() {
                const fileId = $(this).data('id');
                const newName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å:');
                
                if (newName) {
                    renameFile(fileId, newName);
                }
            });
        }

        // æ¸²æŸ“é¢åŒ…å±‘å¯¼èˆª
        function renderBreadcrumb(path) {
            const $breadcrumb = $('#breadcrumb');
            $breadcrumb.empty();
            
            // æ·»åŠ è¿”å›ä¸Šä¸€çº§
            if (path !== '/') {
                $breadcrumb.append('<a href="#" class="parent-link">è¿”å›ä¸Šä¸€çº§</a>');
            }
            
            // æ·»åŠ æ ¹ç›®å½•
            $breadcrumb.append('<a href="#" class="home-link">æ ¹ç›®å½•</a>');
            
            // æ·»åŠ è·¯å¾„å„éƒ¨åˆ†
            if (path !== '/') {
                const parts = path.split('/').filter(p => p);
                let currentPath = '';
                
                parts.forEach(part => {
                    currentPath += '/' + part;
                    $breadcrumb.append(`<span>/</span><a href="#" class="path-link" data-path="${currentPath}">${part}</a>`);
                });
            }
            
            // ç»‘å®šé¢åŒ…å±‘äº‹ä»¶
            $('.home-link').click(function(e) {
                e.preventDefault();
                currentPath = '/';
                currentPage = 1;
                searchQuery = '';
                loadFileList();
            });
            
            $('.parent-link').click(function(e) {
                e.preventDefault();
                const parts = currentPath.split('/').filter(p => p);
                parts.pop();
                currentPath = '/' + parts.join('/');
                if (currentPath === '') currentPath = '/';
                currentPage = 1;
                loadFileList();
            });
            
            $('.path-link').click(function(e) {
                e.preventDefault();
                currentPath = $(this).data('path');
                currentPage = 1;
                loadFileList();
            });
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(total, page, pages) {
            const $pagination = $('#pagination');
            $pagination.empty();
            
            if (pages <= 1) return;
            
            // ä¸Šä¸€é¡µ
            if (page > 1) {
                $pagination.append(`<a href="#" class="page-link" data-page="${page - 1}">ä¸Šä¸€é¡µ</a>`);
            }
            
            // é¡µç 
            for (let i = 1; i <= pages; i++) {
                if (i === page) {
                    $pagination.append(`<a href="#" class="page-link active" data-page="${i}">${i}</a>`);
                } else {
                    $pagination.append(`<a href="#" class="page-link" data-page="${i}">${i}</a>`);
                }
            }
            
            // ä¸‹ä¸€é¡µ
            if (page < pages) {
                $pagination.append(`<a href="#" class="page-link" data-page="${page + 1}">ä¸‹ä¸€é¡µ</a>`);
            }
            
            // ç»‘å®šåˆ†é¡µäº‹ä»¶
            $('.page-link').click(function(e) {
                e.preventDefault();
                currentPage = $(this).data('page');
                loadFileList();
            });
        }

        // å¤„ç†æœç´¢
        function handleSearch() {
            searchQuery = $('#search-input').val();
            currentPage = 1;
            loadFileList();
            searchQuery = '';
        }

        // å¤„ç†æ’åº
        function handleSort() {
            const field = $(this).data('sort');
            
            // æ›´æ–°æ’åºæŒ‡ç¤ºå™¨
            $('.sort-indicator').text('');
            if (sortField === field) {
                sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                sortField = field;
                sortOrder = 'asc';
            }
            $(this).find('.sort-indicator').text(sortOrder === 'asc' ? 'â†‘' : 'â†“');
            
            currentPage = 1;
            loadFileList();
        }
        
        function handleCreateDir(dirName){
            $.ajax({
                url: `/api/files/dir`,
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                data: JSON.stringify({
                    dirname: dirName,
                    path: currentPath
                }),
                success: function() {
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºæˆåŠŸ');
                    loadFileList();
                    // å¦‚æœä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸ªäººä¸­å¿ƒæ–‡ä»¶åˆ—è¡¨
                    if ($('#profile-modal').is(':visible')) {
                        loadUserFiles();
                    }
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleUpload() {
            const files = $('#file-input')[0].files;
            if (files.length === 0) {
                alert('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶');
                return;
            }
            
            // é‡ç½®ä¸Šä¼ çŠ¶æ€
            resetUploadProgress();
            
            // æ˜¾ç¤ºè¿›åº¦æ¡
            $('#upload-progress-container').show();
            
            // è®¾ç½®ä¸Šä¼ å¼€å§‹æ—¶é—´
            uploadStartTime = Date.now();
            
            const formData = new FormData();
            for (let i = 0; i < files.length; i++) {
                formData.append('file', files[i]);
            }
            formData.append('path', currentPath);
            
            // æ˜¾ç¤ºç¬¬ä¸€ä¸ªæ–‡ä»¶å
            if (files.length === 1) {
                $('#upload-file-name').text(`æ­£åœ¨ä¸Šä¼ : ${files[0].name}`);
            } else {
                $('#upload-file-name').text(`æ­£åœ¨ä¸Šä¼  ${files.length} ä¸ªæ–‡ä»¶`);
            }
            
            // åˆ›å»ºXMLHttpRequestå¯¹è±¡ä»¥è·Ÿè¸ªè¿›åº¦
            uploadXHR = new XMLHttpRequest();
            
            // ç›‘å¬ä¸Šä¼ è¿›åº¦
            uploadXHR.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    updateUploadProgress(percentComplete, e.loaded, e.total);
                }
            });
            
            // ç›‘å¬ä¸Šä¼ å®Œæˆ
            uploadXHR.addEventListener('load', function() {
                if (uploadXHR.status === 200) {
                    uploadComplete();
                } else {
                    uploadError('ä¸Šä¼ å¤±è´¥: ' + uploadXHR.statusText);
                }
            });
            
            // ç›‘å¬ä¸Šä¼ é”™è¯¯
            uploadXHR.addEventListener('error', function() {
                uploadError('ä¸Šä¼ è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯');
            });
            
            // ç›‘å¬ä¸Šä¼ ä¸­æ­¢
            uploadXHR.addEventListener('abort', function() {
                uploadError('ä¸Šä¼ å·²å–æ¶ˆ');
            });
            
            // å¼€å§‹ä¸Šä¼ 
            uploadXHR.open('POST', '/api/files/upload');
            uploadXHR.setRequestHeader('Authorization', `Bearer ${localStorage.getItem('token')}`);
            uploadXHR.send(formData);
            
            // å¼€å§‹æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
            uploadProgressInterval = setInterval(updateUploadSpeed, 500);
        }

        // æ›´æ–°ä¸Šä¼ è¿›åº¦
        function updateUploadProgress(percent, loaded, total) {
            const progressFill = $('#upload-progress-fill');
            const percentage = $('#upload-percentage');
            
            progressFill.css('width', percent + '%');
            percentage.text(Math.round(percent) + '%');
            
            // æ›´æ–°çŠ¶æ€æ–‡æœ¬
            $('#upload-status-text').text(`å·²ä¸Šä¼ : ${formatFileSize(loaded)} / ${formatFileSize(total)}`);
        }

        // æ›´æ–°ä¸Šä¼ é€Ÿåº¦
        function updateUploadSpeed() {
            const now = Date.now();
            const elapsed = (now - uploadStartTime) / 1000; // è½¬æ¢ä¸ºç§’
            
            if (elapsed > 0) {
                // è¿™é‡Œéœ€è¦çŸ¥é“å·²ä¸Šä¼ çš„å­—èŠ‚æ•°
                // ç”±äºæˆ‘ä»¬æ— æ³•ç›´æ¥ä»XHRè·å–ï¼Œæˆ‘ä»¬é€šè¿‡è¿›åº¦äº‹ä»¶æ›´æ–°
                // è¿™ä¸ªå‡½æ•°ä¸»è¦ä¸ºäº†å±•ç¤ºå¦‚ä½•å®ç°ï¼Œå®é™…å®ç°éœ€è¦è°ƒæ•´
                $('#upload-speed').text('è®¡ç®—ä¸­...');
            }
        }

        // ä¸Šä¼ å®Œæˆ
        function uploadComplete() {
            clearInterval(uploadProgressInterval);
            
            $('#upload-status-text').text('ä¸Šä¼ å®Œæˆ!');
            $('#upload-progress-fill').css('width', '100%');
            $('#upload-percentage').text('100%');
            $('#upload-speed').text('');
            
            // ç¦ç”¨å–æ¶ˆæŒ‰é’®
            $('#upload-cancel-btn').prop('disabled', true);
            
            // 2ç§’åéšè—è¿›åº¦æ¡
            setTimeout(function() {
                $('#upload-progress-container').hide();
                resetUploadProgress();
                
                // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                loadFileList();
                
                // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
                $('#file-input').val('');
            }, 2000);
            
        }

        // ä¸Šä¼ é”™è¯¯
        function uploadError(message) {
            clearInterval(uploadProgressInterval);
            
            $('#upload-status-text').text(message);
            $('#upload-progress-fill').css('background', '#e74c3c');
            
            // 3ç§’åéšè—è¿›åº¦æ¡
            setTimeout(function() {
                $('#upload-progress-container').hide();
                resetUploadProgress();
            }, 3000);
        }

        // å–æ¶ˆä¸Šä¼ 
        function cancelUpload() {
            if (uploadXHR) {
                uploadXHR.abort();
            }
            clearInterval(uploadProgressInterval);
            $('#upload-progress-container').hide();
            resetUploadProgress();
        }

        // é‡ç½®ä¸Šä¼ è¿›åº¦
        function resetUploadProgress() {
            $('#upload-progress-fill').css({
                'width': '0%',
                'background': 'linear-gradient(90deg, #23936f, #2ecc71)'
            });
            $('#upload-percentage').text('0%');
            $('#upload-status-text').text('å‡†å¤‡ä¸Šä¼ ...');
            $('#upload-speed').text('0 KB/s');
            $('#upload-file-name').text('æ­£åœ¨ä¸Šä¼ : æ–‡ä»¶å');
            $('#upload-cancel-btn').prop('disabled', false);
            
            uploadXHR = null;
            uploadStartTime = 0;
        }

        // åˆ é™¤æ–‡ä»¶
        function deleteFile(fileId) {
            $.ajax({
                url: `/api/files/${fileId}`,
                type: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                success: function() {
                    alert('æ–‡ä»¶åˆ é™¤æˆåŠŸ');
                    loadFileList();
                    // å¦‚æœä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸ªäººä¸­å¿ƒæ–‡ä»¶åˆ—è¡¨
                    if ($('#profile-modal').is(':visible')) {
                        loadUserFiles();
                    }
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶åˆ é™¤å¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // é‡å‘½åæ–‡ä»¶
        function renameFile(fileId, newName) {
            $.ajax({
                url: `/api/files/${fileId}`,
                type: 'PUT',
                contentType: 'application/json',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                data: JSON.stringify({name: newName}),
                success: function() {
                    alert('æ–‡ä»¶é‡å‘½åæˆåŠŸ');
                    loadFileList();
                    // å¦‚æœä¸ªäººä¸­å¿ƒæ¨¡æ€æ¡†æ˜¯æ‰“å¼€çš„ï¼Œä¹Ÿåˆ·æ–°ä¸ªäººä¸­å¿ƒæ–‡ä»¶åˆ—è¡¨
                    if ($('#profile-modal').is(':visible')) {
                        loadUserFiles();
                    }
                },
                error: function(xhr) {
                    alert('æ–‡ä»¶é‡å‘½åå¤±è´¥: ' + (xhr.responseJSON?.detail || 'æœªçŸ¥é”™è¯¯'));
                }
            });
        }

        // åŠ è½½ç”¨æˆ·æ–‡ä»¶
        function loadUserFiles() {
            const params = {
                page: profileCurrentPage,
                page_size: profilePageSize,
                sort: profileSortField,
                order: profileSortOrder
            };
            
            if (profileSearchQuery) {
                params.q = profileSearchQuery;
            }
            
            $.ajax({
                url: '/api/users/me/files',
                type: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                data: params,
                success: function(response) {
                    renderUserFiles(response.files);
                    renderProfilePagination(response.total, response.page, response.pages);
                },
                error: function(xhr) {
                    console.error('åŠ è½½ç”¨æˆ·æ–‡ä»¶å¤±è´¥:', xhr);
                }
            });
        }

        // æ¸²æŸ“ç”¨æˆ·æ–‡ä»¶
        function renderUserFiles(files) {
            const $profileFileListBody = $('#profile-file-list-body');
            $profileFileListBody.empty();
            
            if (files.length === 0) {
                $profileFileListBody.append('<tr><td colspan="4" style="text-align:center;">æš‚æ— æ–‡ä»¶</td></tr>');
                return;
            }
            
            files.forEach(file => {
                const icon = getFileIcon(file);
                const size = file.is_directory ? '-' : formatFileSize(file.size);
                const modified = formatDate(file.modified_time);
                
                const $row = $(`
                    <tr>
                        <td class="file-name">
                            ${icon}
                            <a href="/api/files/${file.id}/download" target="_blank">${file.name}</a>
                        </td>
                        <td>${size}</td>
                        <td>${modified}</td>
                        <td class="actions">
                            <a class="rename-btn" data-id="${file.id}">é‡å‘½å</a>
                            <a class="delete-btn" data-id="${file.id}">åˆ é™¤</a>
                            <a href="/api/files/${file.id}/download" class="download-btn">ä¸‹è½½</a>
                        </td>
                    </tr>
                `);
                
                $profileFileListBody.append($row);
            });
            
            // ç»‘å®šä¸ªäººä¸­å¿ƒæ–‡ä»¶æ“ä½œäº‹ä»¶
            $profileFileListBody.find('.delete-btn').click(function() {
                const fileId = $(this).data('id');
                if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ–‡ä»¶å—ï¼Ÿ')) {
                    deleteFile(fileId);
                }
            });
            
            $profileFileListBody.find('.rename-btn').click(function() {
                const fileId = $(this).data('id');
                const newName = prompt('è¯·è¾“å…¥æ–°æ–‡ä»¶å:');
                if (newName) {
                    renameFile(fileId, newName);
                }
            });
        }

        // æ¸²æŸ“ä¸ªäººä¸­å¿ƒåˆ†é¡µ
        function renderProfilePagination(total, page, pages) {
            const $profilePagination = $('#profile-pagination');
            $profilePagination.empty();
            
            if (pages <= 1) return;
            
            // ä¸Šä¸€é¡µ
            if (page > 1) {
                $profilePagination.append(`<a href="#" class="profile-page-link" data-page="${page - 1}">ä¸Šä¸€é¡µ</a>`);
            }
            
            // é¡µç 
            for (let i = 1; i <= pages; i++) {
                if (i === page) {
                    $profilePagination.append(`<a href="#" class="profile-page-link active" data-page="${i}">${i}</a>`);
                } else {
                    $profilePagination.append(`<a href="#" class="profile-page-link" data-page="${i}">${i}</a>`);
                }
            }
            
            // ä¸‹ä¸€é¡µ
            if (page < pages) {
                $profilePagination.append(`<a href="#" class="profile-page-link" data-page="${page + 1}">ä¸‹ä¸€é¡µ</a>`);
            }
            
            // ç»‘å®šä¸ªäººä¸­å¿ƒåˆ†é¡µäº‹ä»¶
            $('.profile-page-link').click(function(e) {
                e.preventDefault();
                profileCurrentPage = $(this).data('page');
                loadUserFiles();
            });
        }

        // å¤„ç†ä¸ªäººä¸­å¿ƒæœç´¢
        function handleProfileSearch() {
            profileSearchQuery = $('#profile-search-input').val();
            profileCurrentPage = 1;
            loadUserFiles();
        }

        // å¤„ç†ä¸ªäººä¸­å¿ƒæ’åº
        function handleProfileSort() {
            const field = $(this).data('sort');
            
            // æ›´æ–°ä¸ªäººä¸­å¿ƒæ’åºæŒ‡ç¤ºå™¨
            $('.profile-sort-indicator').text('');
            if (profileSortField === field) {
                profileSortOrder = profileSortOrder === 'asc' ? 'desc' : 'asc';
            } else {
                profileSortField = field;
                profileSortOrder = 'asc';
            }
            $(this).find('.profile-sort-indicator').text(profileSortOrder === 'asc' ? 'â†‘' : 'â†“');
            
            profileCurrentPage = 1;
            loadUserFiles();
        }

        // è·å–æ–‡ä»¶å›¾æ ‡
        function getFileIcon(file) {
            if (file.is_directory) {
                return '<span class="file-icon-folder">ğŸ“</span>';
            }
            
            const ext = file.name.split('.').pop().toLowerCase();
            const iconMap = {
                'pdf': 'ğŸ“•',
                'zip': 'ğŸ“¦',
                'rar': 'ğŸ“¦',
                '7z': 'ğŸ“¦',
                'jpg': 'ğŸ–¼ï¸',
                'jpeg': 'ğŸ–¼ï¸',
                'png': 'ğŸ–¼ï¸',
                'gif': 'ğŸ–¼ï¸',
                'txt': 'ğŸ“„',
                'doc': 'ğŸ“„',
                'docx': 'ğŸ“„',
                'xls': 'ğŸ“Š',
                'xlsx': 'ğŸ“Š',
                'ppt': 'ğŸ“½ï¸',
                'pptx': 'ğŸ“½ï¸',
                'mp3': 'ğŸµ',
                'wav': 'ğŸµ',
                'mp4': 'ğŸ¬',
                'avi': 'ğŸ¬',
                'mov': 'ğŸ¬'
            };
            
            return iconMap[ext] || '<span class="file-icon-other">ğŸ“„</span>';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleString('zh-CN');
        }
    </script>
</body>
</html>
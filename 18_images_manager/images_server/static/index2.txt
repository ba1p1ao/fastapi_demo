<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æœåŠ¡å™¨</title>
    <!-- å¼•å…¥ jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .upload-section {
            padding: 30px;
            border-bottom: 1px solid #eee;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s ease;
            background: #f8f9fa;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #e9ecef;
            border-color: #5a67d8;
        }

        .upload-area.dragover {
            background: #dee2e6;
            border-color: #4c51bf;
        }

        .upload-icon {
            font-size: 3em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin-top: 15px;
            overflow: hidden;
            display: none;
        }

        .progress {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .gallery-section {
            padding: 30px;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .image-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
        }

        .image-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
            cursor: pointer;
        }

        .image-info {
            padding: 15px;
        }

        .image-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-size {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .image-actions {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            flex: 1;
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8em;
            transition: background 0.2s ease;
        }

        .download-btn {
            background: #48bb78;
            color: white;
        }

        .download-btn:hover {
            background: #38a169;
        }

        .delete-btn {
            background: #f56565;
            color: white;
        }

        .delete-btn:hover {
            background: #e53e3e;
        }

        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 30px;
            gap: 15px;
        }

        .page-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .page-btn:hover:not(:disabled) {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #48bb78;
            color: white;
            border-radius: 5px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.error {
            background: #f56565;
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ å›¾ç‰‡</h1>
            <p>æ”¯æŒå›¾ç‰‡ä¸Šä¼ ã€æŸ¥çœ‹ã€ä¸‹è½½å’Œç®¡ç†</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h3>æ‹–æ”¾å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</h3>
                <p>æ”¯æŒ JPG, PNG, GIF, WebP æ ¼å¼ï¼Œæœ€å¤§ 50MB</p>
                <input type="file" class="file-input" id="fileInput" accept="image/*" multiple>
                <button class="upload-btn" id="selectImageBtn">
                    é€‰æ‹©å›¾ç‰‡
                </button>
                <div class="progress-bar" id="progressBar">
                    <div class="progress" id="progress"></div>
                </div>
            </div>
        </div>

        <div class="gallery-section">
            <h2>å›¾ç‰‡åº“</h2>
            <div>
                <button class="upload-btn" id="refreshBtn" style="padding: 8px 16px; font-size: 0.9em;">
                    åˆ·æ–°
                </button>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="pagination" id="pagination">
                <button class="page-btn" id="prevPage" disabled>ä¸Šä¸€é¡µ</button>
                <span id="pageInfo">ç¬¬ 1 é¡µ</span>
                <button class="page-btn" id="nextPage">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        const perPage = 20;

        // ä¸Šä¼ ç®¡ç†å™¨ç±» - ä¼˜åŒ–ç‰ˆ
        class UploadManager {
            constructor() {
                this.queue = [];
                this.activeUploads = 0;
                // åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°ï¼šæ ¹æ®æ–‡ä»¶å¤§å°å’Œæ•°é‡æ™ºèƒ½è°ƒæ•´
                this.maxConcurrent = 3; // æ¯ä¸ªç”¨æˆ·åŒæ—¶ä¸Šä¼ 3å¼ 
                this.totalFiles = 0;
                this.processedFiles = 0;
                this.hasRefreshed = false;
                this.uploadStats = {
                    success: 0,
                    failed: 0,
                    total: 0
                };
                // é”™è¯¯é‡è¯•é…ç½®
                this.maxRetries = 3;
                this.retryDelay = 1000; // 1ç§’
            }

            async addFiles(files) {
                const filesArray = Array.from(files);
                this.totalFiles += filesArray.length;
                this.uploadStats.total += filesArray.length;
                this.queue.push(...filesArray);
                this.processQueue();
            }

            async processQueue() {
                while (this.queue.length > 0 && this.activeUploads < this.maxConcurrent) {
                    const file = this.queue.shift();
                    this.activeUploads++;

                    // å¼‚æ­¥å¤„ç†ï¼Œä¸é˜»å¡é˜Ÿåˆ—
                    this.uploadFileWithRetry(file).finally(() => {
                        this.activeUploads--;
                        this.processedFiles++;
                        this.updateProgress();

                        // çŸ­æš‚å»¶è¿Ÿåå¤„ç†ä¸‹ä¸€ä¸ªï¼Œé¿å…è¿‡äºå¯†é›†
                        setTimeout(() => {
                            this.processQueue();
                        }, 50); // å‡å°‘å»¶è¿Ÿåˆ°50ms
                    });
                }
            }

            async uploadFileWithRetry(file, retryCount = 0) {
                try {
                    await this.uploadFile(file);
                    this.uploadStats.success++;
                    // æ¯å¼ å›¾ç‰‡ä¸Šä¼ æˆåŠŸåç«‹å³æ˜¾ç¤ºæç¤º
                    showToast(`"${file.name}" ä¸Šä¼ æˆåŠŸï¼`, 'success');
                } catch (error) {
                    if (retryCount < this.maxRetries) {
                        // æŒ‡æ•°é€€é¿é‡è¯•
                        const delay = this.retryDelay * Math.pow(2, retryCount);
                        console.log(`ä¸Šä¼ å¤±è´¥ ${file.name}ï¼Œ${delay}msåé‡è¯•... (${retryCount + 1}/${this.maxRetries})`);
                        await this.delay(delay);
                        return this.uploadFileWithRetry(file, retryCount + 1);
                    } else {
                        this.uploadStats.failed++;
                        console.error(`ä¸Šä¼ å¤±è´¥ ${file.name}:`, error);
                        // æ‰¹é‡æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…è¿‡å¤šToast
                        this.showBatchError(file.name, error.message);
                    }
                }
            }

            async uploadFile(file) {
                // éªŒè¯æ–‡ä»¶
                if (!file.type.startsWith('image/')) {
                    throw new Error(`"${file.name}" ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`);
                }

                if (file.size > 50 * 1024 * 1024) {
                    throw new Error(`"${file.name}" è¶…è¿‡50MBé™åˆ¶`);
                }

                const formData = new FormData();
                formData.append('file', file);

                // æ·»åŠ è¶…æ—¶æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000); // 2åˆ†é’Ÿè¶…æ—¶

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTPé”™è¯¯ ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        // ä¸æ˜¾ç¤ºå•ä¸ªæ–‡ä»¶çš„æˆåŠŸæç¤ºï¼Œé¿å…Toastè¿‡å¤š
                        return result;
                    } else {
                        throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('ä¸Šä¼ è¶…æ—¶');
                    }
                    throw error;
                }
            }

            updateProgress() {
                const percentage = (this.processedFiles / this.totalFiles) * 100;
                $('#progress').css('width', `${percentage}%`);

                // å½“æ‰€æœ‰æ–‡ä»¶éƒ½å¤„ç†å®Œæˆæ—¶
                if (this.processedFiles === this.totalFiles && this.queue.length === 0 && this.activeUploads === 0) {
                    if (!this.hasRefreshed) {
                        this.hasRefreshed = true;

                        // æ˜¾ç¤ºæ‰¹é‡ä¸Šä¼ ç»“æœ
                        const successCount = this.uploadStats.success;
                        const failedCount = this.uploadStats.failed;
                        if (failedCount > 0) {
                            showToast(`ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failedCount} å¼ `, 'error');
                        } else {
                            showToast(`æˆåŠŸä¸Šä¼  ${successCount} å¼ å›¾ç‰‡ï¼`, 'success');
                        }

                        // ç­‰å¾…åç«¯å¤„ç†ç¼©ç•¥å›¾ååˆ·æ–°
                        setTimeout(() => {
                            $('#progressBar').hide();
                            $('#progress').css('width', '0%');
                            loadImages();
                            // é‡ç½®
                            this.totalFiles = 0;
                            this.processedFiles = 0;
                            this.hasRefreshed = false;
                            this.uploadStats = { success: 0, failed: 0, total: 0 };
                        }, 2000); // å¢åŠ ç­‰å¾…æ—¶é—´ç¡®ä¿ç¼©ç•¥å›¾ç”Ÿæˆ
                    }
                }
            }

            showBatchError(filename, errorMsg) {
                // æ‰¹é‡é”™è¯¯æ˜¾ç¤ºï¼Œé¿å…è¿‡å¤šToast
                if (!this.errorQueue) {
                    this.errorQueue = [];
                }
                this.errorQueue.push({ filename, errorMsg });

                // å»¶è¿Ÿæ˜¾ç¤ºï¼Œåˆå¹¶é”™è¯¯
                if (!this.errorTimer) {
                    this.errorTimer = setTimeout(() => {
                        const errors = this.errorQueue.slice();
                        this.errorQueue = [];
                        this.errorTimer = null;

                        if (errors.length > 0) {
                            const errorList = errors.slice(0, 3).map(e => e.filename).join(', ');
                            const more = errors.length > 3 ? `ç­‰ ${errors.length} ä¸ªæ–‡ä»¶` : '';
                            showToast(`ä¸Šä¼ å¤±è´¥: ${errorList}${more}`, 'error');
                        }
                    }, 500);
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // åˆå§‹åŒ–ä¸Šä¼ ç®¡ç†å™¨
        const uploadManager = new UploadManager();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function () {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ä¸­...');
            loadImages();
            setupDragAndDrop();

            // åˆå§‹åŒ–æŒ‰é’®äº‹ä»¶
            $('#selectImageBtn').on('click', function () {
                $('#fileInput').click();
            });

            $('#refreshBtn').on('click', function () {
                loadImages();
            });

            $('#prevPage').on('click', function () {
                if (currentPage > 1) {
                    currentPage--;
                    loadImages();
                }
            });

            $('#nextPage').on('click', function () {
                currentPage++;
                loadImages();
            });
        });

        // è®¾ç½®æ‹–æ”¾åŠŸèƒ½
        function setupDragAndDrop() {
            const $uploadArea = $('#uploadArea');
            const $fileInput = $('#fileInput');

            if (!$uploadArea.length || !$fileInput.length) {
                console.error('æ‰¾ä¸åˆ°ä¸Šä¼ åŒºåŸŸæˆ–æ–‡ä»¶è¾“å…¥æ¡†');
                return;
            }

            $uploadArea.on('dragover', function (e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            $uploadArea.on('dragleave', function () {
                $(this).removeClass('dragover');
            });

            $uploadArea.on('drop', function (e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });

            $fileInput.on('change', function (e) {
                handleFiles(e.target.files);
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFiles(files) {
            $('#progressBar').show();
            $('#progress').css('width', '0%');

            // ä½¿ç”¨ä¸Šä¼ ç®¡ç†å™¨
            uploadManager.addFiles(files);
        }

        // åŠ è½½å›¾ç‰‡åˆ—è¡¨
        async function loadImages() {
            const $galleryGrid = $('#galleryGrid');

            if (!$galleryGrid.length) {
                console.error('æ‰¾ä¸åˆ°å›¾ç‰‡ç½‘æ ¼å®¹å™¨');
                return;
            }

            $galleryGrid.html('<div class="loading">åŠ è½½ä¸­...</div>');

            try {
                const response = await fetch(`/images?page=${currentPage}&per_page=${perPage}`);

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                console.log('è·å–åˆ°çš„å›¾ç‰‡æ•°æ®:', data);

                if (!data.images || data.images.length === 0) {
                    $galleryGrid.html('<div class="loading">æš‚æ— å›¾ç‰‡</div>');
                    updatePagination(0);
                    return;
                }

                $galleryGrid.empty();

                data.images.forEach(image => {
                    const imageCard = createImageCard(image);
                    $galleryGrid.append(imageCard);
                });

                updatePagination(data.images.length);

            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                $galleryGrid.html('<div class="loading" style="color: red;">åŠ è½½å¤±è´¥: ' + error.message + '</div>');
                showToast('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åˆ›å»ºå›¾ç‰‡å¡ç‰‡
        function createImageCard(image) {
            const thumbnailUrl = `/thumbnail/${image.filename}`;
            const downloadUrl = `/download/${image.filename}`;

            const $card = $('<div>', {
                class: 'image-card',
                'data-filename': image.filename,
                'data-original-name': image.original_name
            });

            $card.html(`
                <img src="${thumbnailUrl}" alt="${image.original_name}" class="image-thumbnail">
                <div class="image-info">
                    <div class="image-name" title="${image.original_name}">${image.original_name}</div>
                    <div class="image-size">${formatFileSize(image.size)}</div>
                    <div class="image-actions">
                        <button class="action-btn download-btn">ä¸‹è½½</button>
                        <button class="action-btn delete-btn">åˆ é™¤</button>
                    </div>
                </div>
            `);

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            $card.find('.image-thumbnail').on('click', function () {
                viewImage(image.filename);
            });

            $card.find('.download-btn').on('click', function () {
                downloadImage(downloadUrl, image.original_name);
            });

            $card.find('.delete-btn').on('click', function () {
                deleteImage(image.filename);
            });

            // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
            $card.find('.image-thumbnail').on('error', function () {
                console.warn('ç¼©ç•¥å›¾åŠ è½½å¤±è´¥:', thumbnailUrl);
                $(this).attr('src', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1geWHk+aWh+eroDwvdGV4dD48L3N2Zz4=');
            });

            return $card[0];
        }

        // æŸ¥çœ‹å›¾ç‰‡
        function viewImage(filename) {
            window.open(`/uploads/${filename}`, '_blank');
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('å¼€å§‹ä¸‹è½½: ' + filename);
        }

        // åˆ é™¤å›¾ç‰‡
        async function deleteImage(filename) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/image/${filename}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadImages(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤é”™è¯¯:', error);
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(itemsCount) {
            const $prevBtn = $('#prevPage');
            const $nextBtn = $('#nextPage');
            const $pageInfo = $('#pageInfo');

            if (!$prevBtn.length || !$nextBtn.length || !$pageInfo.length) {
                console.error('æ‰¾ä¸åˆ°åˆ†é¡µå…ƒç´ ');
                return;
            }

            $prevBtn.prop('disabled', currentPage === 1);
            $pageInfo.text(`ç¬¬ ${currentPage} é¡µ`);
            $nextBtn.prop('disabled', itemsCount < perPage);
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const $toast = $('#toast');

            if (!$toast.length) {
                console.error('æ‰¾ä¸åˆ°Toastå…ƒç´ ');
                return;
            }

            $toast.text(message)
                .attr('class', `toast ${type} show`);

            setTimeout(() => {
                $toast.removeClass('show');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>

</html>
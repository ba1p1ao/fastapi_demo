<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æœåŠ¡å™¨</title>
    <!-- å¼•å…¥ jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
     *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;color:#333}
    .container{max-width:1200px;margin:0 auto;background:white;border-radius:15px;box-shadow:0 20px 40px rgba(0,0,0,0.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:30px;text-align:center}
    .header h1{font-size:2.5em;margin-bottom:10px}
    .upload-section{padding:30px;border-bottom:1px solid #eee}
    .upload-area{border:3px dashed #667eea;border-radius:10px;padding:40px;text-align:center;transition:all 0.3s ease;background:#f8f9fa;cursor:pointer;position:relative}
    .upload-area:hover{background:#e9ecef;border-color:#5a67d8}
    .upload-area.dragover{background:#dee2e6;border-color:#4c51bf}
    .upload-icon{font-size:3em;color:#667eea;margin-bottom:15px}
    .file-input{display:none}
    .upload-btn{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;padding:12px 30px;border-radius:25px;cursor:pointer;font-size:1.1em;transition:transform 0.2s ease,box-shadow 0.2s ease;box-shadow:0 4px 6px rgba(102,126,234,0.2)}
    .upload-btn:hover{transform:translateY(-2px);box-shadow:0 6px 8px rgba(102,126,234,0.3)}
    .upload-btn:active{transform:translateY(0)}
    .progress-container{margin-top:20px;display:none}
    .progress-bar{width:100%;height:8px;background:#e9ecef;border-radius:4px;overflow:hidden;margin-bottom:10px}
    .progress{height:100%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);width:0%;transition:width 0.3s ease}
    .progress-text{display:flex;justify-content:space-between;font-size:0.9em;color:#666}
    .file-preview{margin-top:20px;display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
    .file-preview-item{position:relative;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
    .file-preview-item img{width:100%;height:100px;object-fit:cover}
    .file-preview-item .remove-btn{position:absolute;top:5px;right:5px;background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:24px;height:24px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:12px;color:#f56565}
.file-preview-item .file-name{position:absolute;bottom:0;left:0;right:0;background:rgba(0,0,0,0.7);color:white;padding:4px 6px;font-size:0.75em;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.gallery-section{padding:30px}
.section-header{display:grid;grid-template-columns:1fr auto;align-items:center;margin-bottom:20px;gap:20px}
.section-header h2{font-size:1.8em;color:#333}
.gallery-controls{display:flex;gap:10px;align-items:center;justify-content:flex-end;flex-wrap:nowrap}
.search-container{display:flex;align-items:center;width:250px;background:white;border-radius:20px;overflow:hidden;box-shadow:inset 0 0 0 1px #ddd,0 2px 4px rgba(0,0,0,0.1);transition:all 0.3s ease}
.search-container:focus-within{box-shadow:inset 0 0 0 2px #667eea,0 2px 8px rgba(102,126,234,0.2)}
.search-box{border:none;padding:8px 12px;outline:none;width:100%;background:transparent;font-size:0.9em}
.search-box::placeholder{color:#999}
.search-btn{background:#667eea;color:white;border:1px solid #667eea;border-left:none;border-radius:0 20px 20px 0;padding:8px 12px;cursor:pointer;transition:all 0.2s ease;height:36px;flex-shrink:0;display:flex;align-items:center;justify-content:center;min-width:44px}
.search-btn:active{border-width:1px;border-color:#667eea}
.search-btn:focus{outline:none;box-shadow:0 0 0 2px rgba(102,126,234,0.3)}
.search-loading{margin-left:10px;width:16px;height:16px;border:2px solid #f3f3f3;border-top:2px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;display:none}
@keyframes spin{0%{transform:rotate(0deg)}
100%{transform:rotate(360deg)}
}.refresh-btn{background:#48bb78;color:white;border:none;padding:8px 16px;border-radius:20px;cursor:pointer;font-size:0.9em;transition:all 0.2s ease}
.refresh-btn:hover{background:#38a169}
.gallery-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:20px;margin-top:20px;opacity:1;transition:opacity 0.3s ease}
.gallery-grid.loading{opacity:0.5;pointer-events:none}
.image-card{background:white;border-radius:10px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,0.1);transition:transform 0.3s ease,box-shadow 0.3s ease;animation:fadeIn 0.3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}
to{opacity:1;transform:translateY(0)}
}.image-card:hover{transform:translateY(-5px);box-shadow:0 15px 30px rgba(0,0,0,0.2)}
.image-thumbnail{width:100%;height:150px;object-fit:cover;cursor:pointer;transition:transform 0.3s ease}
.image-card:hover .image-thumbnail{transform:scale(1.05)}
.image-info{padding:15px}
.image-name{font-weight:bold;margin-bottom:5px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.image-meta{display:flex;justify-content:space-between;color:#666;font-size:0.9em;margin-bottom:10px}
.image-actions{display:flex;gap:5px}
.action-btn{flex:1;padding:6px 10px;border:none;border-radius:5px;cursor:pointer;font-size:0.8em;transition:background 0.2s ease}
.download-btn{background:#48bb78;color:white}
.download-btn:hover{background:#38a169}
.delete-btn{background:#f56565;color:white}
.delete-btn:hover{background:#e53e3e}
.pagination{display:flex;justify-content:center;align-items:center;margin-top:30px;gap:15px}
.page-btn{padding:8px 16px;border:1px solid #ddd;background:white;border-radius:5px;cursor:pointer;transition:all 0.2s ease}
.page-btn:hover:not(:disabled){background:#667eea;color:white;border-color:#667eea}
.page-btn:disabled{opacity:0.5;cursor:not-allowed}
.page-info{font-size:0.9em;color:#666}
.loading{text-align:center;padding:20px;color:#666}
.empty-state{text-align:center;padding:40px;color:#666}
.empty-state-icon{font-size:4em;margin-bottom:20px;opacity:0.5}
.toast{position:fixed;top:20px;right:20px;padding:15px 25px;background:#48bb78;color:white;border-radius:5px;box-shadow:0 5px 15px rgba(0,0,0,0.2);transform:translateX(400px);transition:transform 0.3s ease;z-index:1000;display:flex;align-items:center;gap:10px}
.toast.show{transform:translateX(0)}
.toast.error{background:#f56565}
.toast.info{background:#4299e1}
.toast-icon{font-size:1.2em}
.modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.85);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;visibility:hidden;transition:opacity 0.3s ease,visibility 0.3s ease}
.modal.show{opacity:1;visibility:visible}
.modal-content{background:white;border-radius:10px;max-width:90%;max-height:90%;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,0.3);transform:scale(0.9);transition:transform 0.3s ease;position:relative}
.modal.show .modal-content{transform:scale(1)}
.modal-header{padding:15px 20px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;background:white;position:absolute;top:0;left:0;right:0;z-index:10}
.modal-body{padding:60px 20px 20px;text-align:center;overflow:auto;max-height:calc(90vh - 80px)}
.modal-image{max-width:100%;max-height:70vh;object-fit:contain}
.modal-close{background:none;border:none;font-size:1.5em;cursor:pointer;color:#666}
.modal-actions{display:flex;gap:10px;justify-content:center;margin-top:20px}
.modal-btn{padding:8px 16px;border:none;border-radius:5px;cursor:pointer;font-size:0.9em}
.modal-btn.confirm{background:#f56565;color:white}
.modal-btn.cancel{background:#e2e8f0;color:#333}
.image-navigation{position:absolute;top:50%;left:0;right:0;display:flex;justify-content:space-between;transform:translateY(-50%);padding:0 20px;z-index:5}
.nav-btn{background:rgba(255,255,255,0.8);border:none;border-radius:50%;width:50px;height:50px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.5em;color:#333;box-shadow:0 2px 10px rgba(0,0,0,0.2);transition:all 0.2s ease}
.nav-btn:hover{background:white;transform:scale(1.1)}
.nav-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none}
.image-counter{position:absolute;bottom:20px;left:0;right:0;text-align:center;color:white;font-size:0.9em;background:rgba(0,0,0,0.5);padding:5px 10px;margin:0 auto;width:fit-content;border-radius:15px}
@media (max-width:768px){.container{border-radius:10px}
.header{padding:20px}
.header h1{font-size:2em}
.upload-section,.gallery-section{padding:20px}
.upload-area{padding:20px}
.section-header{flex-direction:column;align-items:flex-start;gap:15px}
.gallery-controls{width:100%;justify-content:space-between}
.search-container{flex-grow:1;min-width:150px;width:auto}
.search-box{width:150px;flex:1px}
.search-btn{background:#667eea;color:white;border:none;padding:8px 12px;cursor:pointer;transition:all 0.2s ease;display:flex;align-items:center;justify-content:center;white-space:nowrap;position:static;transform:none}
.search-btn:hover{background:#5a67d8}
.gallery-grid{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px}
.nav-btn{width:40px;height:40px;font-size:1.2em}
}@media (max-width:480px){.gallery-controls{flex-direction:column;align-items:stretch}
.search-container{width:100%}
.search-btn{position:static;transform:none}
}.upload-actions{margin-top:20px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.upload-confirm-btn{background:linear-gradient(135deg,#48bb78 0%,#38a169 100%);color:white;border:none;padding:12px 30px;border-radius:25px;cursor:pointer;font-size:1.1em;transition:transform 0.2s ease,box-shadow 0.2s ease;box-shadow:0 4px 6px rgba(72,187,120,0.2)}
.upload-confirm-btn:hover{transform:translateY(-2px);box-shadow:0 6px 8px rgba(72,187,120,0.3)}
.upload-confirm-btn:disabled{background:#a0aec0;cursor:not-allowed;transform:none;box-shadow:none}
.cancel-upload-btn{background:#e2e8f0;color:#4a5568;border:none;padding:12px 30px;border-radius:25px;cursor:pointer;font-size:1.1em;transition:all 0.2s ease}
.cancel-upload-btn:hover{background:#cbd5e0}
.file-preview-item.upload-success{border:2px solid #48bb78}
.file-preview-item.upload-error{border:2px solid #f56565}
.upload-status{position:absolute;top:5px;left:5px;background:rgba(0,0,0,0.7);color:white;padding:2px 6px;border-radius:10px;font-size:0.7em}
.upload-status.success{background:rgba(72,187,120,0.9)}
.upload-status.error{background:rgba(245,101,101,0.9)}
.upload-status.uploading{background:rgba(66,153,225,0.9)}
.upload-summary{margin-top:15px;padding:10px;background:#f7fafc;border-radius:8px;text-align:center;font-size:0.9em;color:#4a5568}
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¸ å›¾ç‰‡æœåŠ¡å™¨</h1>
            <p>è½»æ¾ä¸Šä¼ ã€ç®¡ç†å’Œåˆ†äº«æ‚¨çš„å›¾ç‰‡</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">ğŸ“</div>
                <h3>æ‹–æ”¾å›¾ç‰‡åˆ°è¿™é‡Œæˆ–ç‚¹å‡»é€‰æ‹©</h3>
                <p>æ”¯æŒ JPG, PNG, GIF, WebP æ ¼å¼ï¼Œæœ€å¤§ 50MB</p>
                <input type="file" class="file-input" id="fileInput" accept="image/*" multiple>
                <button class="upload-btn" id="selectImageBtn">
                    é€‰æ‹©å›¾ç‰‡
                </button>
            </div>

            <!-- æ–°å¢ä¸Šä¼ æ“ä½œæŒ‰é’® -->
            <div class="upload-actions" id="uploadActions" style="display: none;">
                <button class="upload-confirm-btn" id="confirmUploadBtn" disabled>
                    ç¡®è®¤ä¸Šä¼ 
                </button>
                <button class="cancel-upload-btn" id="cancelUploadBtn">
                    å–æ¶ˆä¸Šä¼ 
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress" id="progress"></div>
                </div>
                <div class="progress-text">
                    <span id="progressStatus">å‡†å¤‡ä¸Šä¼ ...</span>
                    <span id="progressPercent">0%</span>
                </div>
            </div>

            <!-- ä¸Šä¼ æ‘˜è¦ä¿¡æ¯ -->
            <div class="upload-summary" id="uploadSummary" style="display: none;">
                å·²é€‰æ‹© <span id="fileCount">0</span> ä¸ªæ–‡ä»¶ï¼Œæ€»è®¡ <span id="totalSize">0 B</span>
            </div>

            <div class="file-preview" id="filePreview"></div>
        </div>

        <!-- å…¶ä½™éƒ¨åˆ†ä¿æŒä¸å˜ -->
        <div class="gallery-section">
            <div class="section-header">
                <h2>å›¾ç‰‡åº“</h2>
                <div class="gallery-controls">
                    <div class="search-container">
                        <input type="text" class="search-box" id="searchInput" placeholder="æœç´¢å›¾ç‰‡...">
                        <button class="search-btn" id="searchBtn" title="æœç´¢">
                            ğŸ”
                        </button>
                    </div>
                    <div class="search-loading" id="searchLoading"></div>
                    <button class="refresh-btn" id="refreshBtn">
                        ğŸ”„ åˆ·æ–°
                    </button>
                </div>
            </div>
            <div class="gallery-grid" id="galleryGrid">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div class="pagination" id="pagination">
                <button class="page-btn" id="prevPage" disabled>ä¸Šä¸€é¡µ</button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ</span>
                <button class="page-btn" id="nextPage">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <!-- å…¶ä½™æ¨¡æ€æ¡†å’Œæç¤ºä¿æŒä¸å˜ -->
    <div class="toast" id="toast">
        <span class="toast-icon">âœ…</span>
        <span class="toast-message">æ“ä½œæˆåŠŸ</span>
    </div>

    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">å›¾ç‰‡é¢„è§ˆ</h3>
                <!-- æ·»åŠ ä¸‹è½½æŒ‰é’® -->
                <div class="modal-actions" style="justify-content: flex-end; padding: 0 20px;">
                    <button class="modal-btn download-btn" id="modalDownloadBtn">ä¸‹è½½å›¾ç‰‡</button>
                </div>
                <button class="modal-close" id="modalClose">Ã—</button>
            </div>
            <div class="modal-body">
                <img id="modalImage" class="modal-image" src="" alt="é¢„è§ˆå›¾ç‰‡">

            </div>
            <div class="image-navigation">
                <button class="nav-btn" id="prevImageBtn" disabled>â€¹</button>
                <button class="nav-btn" id="nextImageBtn">â€º</button>
            </div>
            <div class="image-counter" id="imageCounter">1 / 10</div>
        </div>
    </div>

    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
                <button class="modal-close" id="deleteModalClose">Ã—</button>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦åˆ é™¤è¿™å¼ å›¾ç‰‡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
                <div class="modal-actions">
                    <button class="modal-btn cancel" id="cancelDelete">å–æ¶ˆ</button>
                    <button class="modal-btn confirm" id="confirmDelete">ç¡®è®¤åˆ é™¤</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        const perPage = 20;
        let selectedFiles = [];
        let currentDeleteFilename = '';
        let currentPageImages = []; // å­˜å‚¨å½“å‰é¡µçš„å›¾ç‰‡æ•°æ®
        let currentImageIndex = 0; // å½“å‰æŸ¥çœ‹å›¾ç‰‡çš„ç´¢å¼•
        let currentSearchKeyword = ''; // å½“å‰æœç´¢å…³é”®è¯
        let searchController = null; // ç”¨äºå–æ¶ˆæœç´¢è¯·æ±‚
        let isUploading = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨ä¸Šä¼ 

        // ä¸Šä¼ ç®¡ç†å™¨ç±»
        class UploadManager {
            constructor() {
                this.queue = [];
                this.activeUploads = 0;
                this.maxConcurrent = 3;
                this.totalFiles = 0;
                this.processedFiles = 0;
                this.hasRefreshed = false;
                this.uploadStats = {
                    success: 0,
                    failed: 0,
                    total: 0
                };
                this.maxRetries = 3;
                this.retryDelay = 1000;
                this.onProgress = null; // è¿›åº¦å›è°ƒ
                this.onFileComplete = null; // å•ä¸ªæ–‡ä»¶å®Œæˆå›è°ƒ
            }

            setProgressCallback(callback) {
                this.onProgress = callback;
            }

            setFileCompleteCallback(callback) {
                this.onFileComplete = callback;
            }

            async addFiles(files) {
                const filesArray = Array.from(files);
                this.totalFiles += filesArray.length;
                this.uploadStats.total += filesArray.length;
                this.queue.push(...filesArray);

                if (this.onProgress) {
                    this.onProgress(this.processedFiles, this.totalFiles, 0);
                }

                this.processQueue();
            }

            async processQueue() {
                while (this.queue.length > 0 && this.activeUploads < this.maxConcurrent) {
                    const file = this.queue.shift();
                    this.activeUploads++;

                    this.uploadFileWithRetry(file).finally(() => {
                        this.activeUploads--;
                        this.processedFiles++;
                        this.updateProgress();

                        setTimeout(() => {
                            this.processQueue();
                        }, 50);
                    });
                }
            }

            async uploadFileWithRetry(file, retryCount = 0) {
                try {
                    // æ ‡è®°æ–‡ä»¶å¼€å§‹ä¸Šä¼ 
                    if (this.onFileComplete) {
                        this.onFileComplete(file.name, 'uploading');
                    }

                    await this.uploadFile(file);
                    this.uploadStats.success++;

                    if (this.onFileComplete) {
                        this.onFileComplete(file.name, 'success');
                    }

                    showToast(`"${file.name}" ä¸Šä¼ æˆåŠŸï¼`, 'success');
                } catch (error) {
                    if (retryCount < this.maxRetries) {
                        const delay = this.retryDelay * Math.pow(2, retryCount);
                        console.log(`ä¸Šä¼ å¤±è´¥ ${file.name}ï¼Œ${delay}msåé‡è¯•... (${retryCount + 1}/${this.maxRetries})`);
                        await this.delay(delay);
                        return this.uploadFileWithRetry(file, retryCount + 1);
                    } else {
                        this.uploadStats.failed++;
                        console.error(`ä¸Šä¼ å¤±è´¥ ${file.name}:`, error);

                        if (this.onFileComplete) {
                            this.onFileComplete(file.name, 'error', error.message);
                        }

                        this.showBatchError(file.name, error.message);
                    }
                }
            }

            async uploadFile(file) {
                if (!file.type.startsWith('image/')) {
                    throw new Error(`"${file.name}" ä¸æ˜¯å›¾ç‰‡æ–‡ä»¶`);
                }

                if (file.size > 50 * 1024 * 1024) {
                    throw new Error(`"${file.name}" è¶…è¿‡50MBé™åˆ¶`);
                }

                const formData = new FormData();
                formData.append('file', file);

                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000);

                try {
                    const response = await fetch('/upload', {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });

                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTPé”™è¯¯ ${response.status}: ${errorText}`);
                    }

                    const result = await response.json();
                    if (result.success) {
                        return result;
                    } else {
                        throw new Error(result.message || 'ä¸Šä¼ å¤±è´¥');
                    }
                } catch (error) {
                    clearTimeout(timeoutId);
                    if (error.name === 'AbortError') {
                        throw new Error('ä¸Šä¼ è¶…æ—¶');
                    }
                    throw error;
                }
            }

            updateProgress() {
                const percentage = (this.processedFiles / this.totalFiles) * 100;

                if (this.onProgress) {
                    this.onProgress(this.processedFiles, this.totalFiles, percentage);
                }

                // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ–‡ä»¶éƒ½å·²å¤„ç†å®Œæˆ
                if (this.processedFiles === this.totalFiles && this.queue.length === 0 && this.activeUploads === 0) {
                    if (!this.hasRefreshed) {
                        this.hasRefreshed = true;

                        const successCount = this.uploadStats.success;
                        const failedCount = this.uploadStats.failed;

                        // ä¸Šä¼ å®Œæˆåé‡ç½®UIçŠ¶æ€
                        setTimeout(() => {
                            // é‡ç½®ä¸Šä¼ çŠ¶æ€
                            resetUploadState();

                            // æ¸…ç©ºå·²é€‰æ–‡ä»¶å’Œé¢„è§ˆ
                            selectedFiles = [];
                            $('#filePreview').empty();
                            $('#uploadActions').hide();
                            $('#uploadSummary').hide();

                            // åˆ·æ–°å›¾ç‰‡åˆ—è¡¨
                            loadImages();

                            if (failedCount > 0) {
                                showToast(`ä¸Šä¼ å®Œæˆï¼šæˆåŠŸ ${successCount} å¼ ï¼Œå¤±è´¥ ${failedCount} å¼ `, failedCount > 0 ? 'error' : 'success');
                            } else {
                                showToast(`æˆåŠŸä¸Šä¼  ${successCount} å¼ å›¾ç‰‡ï¼`, 'success');
                            }

                            // é‡ç½®ä¸Šä¼ ç®¡ç†å™¨çŠ¶æ€
                            this.totalFiles = 0;
                            this.processedFiles = 0;
                            this.hasRefreshed = false;
                            this.uploadStats = { success: 0, failed: 0, total: 0 };
                        }, 1000); // ç»™ç”¨æˆ·1ç§’é’Ÿçœ‹åˆ°ä¸Šä¼ å®Œæˆçš„çŠ¶æ€
                    }
                }
            }

            reset() {
                this.queue = [];
                this.activeUploads = 0;
                this.totalFiles = 0;
                this.processedFiles = 0;
                this.hasRefreshed = false;
                this.uploadStats = { success: 0, failed: 0, total: 0 };
            }

            showBatchError(filename, errorMsg) {
                if (!this.errorQueue) {
                    this.errorQueue = [];
                }
                this.errorQueue.push({ filename, errorMsg });

                if (!this.errorTimer) {
                    this.errorTimer = setTimeout(() => {
                        const errors = this.errorQueue.slice();
                        this.errorQueue = [];
                        this.errorTimer = null;

                        if (errors.length > 0) {
                            const errorList = errors.slice(0, 3).map(e => e.filename).join(', ');
                            const more = errors.length > 3 ? `ç­‰ ${errors.length} ä¸ªæ–‡ä»¶` : '';
                            showToast(`ä¸Šä¼ å¤±è´¥: ${errorList}${more}`, 'error');
                        }
                    }, 500);
                }
            }

            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // åˆå§‹åŒ–ä¸Šä¼ ç®¡ç†å™¨
        const uploadManager = new UploadManager();

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        $(document).ready(function () {
            console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–ä¸­...');
            loadImages();
            setupDragAndDrop();
            setupEventListeners();

            // è®¾ç½®ä¸Šä¼ ç®¡ç†å™¨çš„å›è°ƒ
            uploadManager.setProgressCallback(onUploadProgress);
            uploadManager.setFileCompleteCallback(onFileUploadComplete);
        });

        // ä¸Šä¼ è¿›åº¦å›è°ƒ
        function onUploadProgress(processed, total, percentage, status = 'uploading') {
            $('#progress').css('width', `${percentage}%`);
            $('#progressPercent').text(`${Math.round(percentage)}%`);

            if (status === 'complete') {
                $('#progressStatus').text('ä¸Šä¼ å®Œæˆ');
            } else {
                $('#progressStatus').text(`æ­£åœ¨ä¸Šä¼  ${processed}/${total}`);
            }
        }

        // å•ä¸ªæ–‡ä»¶ä¸Šä¼ å®Œæˆå›è°ƒ
        function onFileUploadComplete(filename, status, errorMsg = '') {
            // æ›´æ–°é¢„è§ˆé¡¹çš„çŠ¶æ€
            const $previewItems = $('#filePreview .file-preview-item');
            $previewItems.each(function () {
                const $item = $(this);
                const fileName = $item.find('.file-name').text();
                if (fileName === filename) {
                    // ç§»é™¤ç°æœ‰çš„çŠ¶æ€æ ‡è®°
                    $item.find('.upload-status').remove();

                    // æ·»åŠ çŠ¶æ€æ ‡è®°
                    let statusText = '';
                    let statusClass = '';

                    if (status === 'success') {
                        statusText = 'âœ“ æˆåŠŸ';
                        statusClass = 'success';
                        $item.addClass('upload-success').removeClass('upload-error');
                    } else if (status === 'error') {
                        statusText = 'âœ— å¤±è´¥';
                        statusClass = 'error';
                        $item.addClass('upload-error').removeClass('upload-success');
                    } else if (status === 'uploading') {
                        statusText = 'â³ ä¸Šä¼ ä¸­';
                        statusClass = 'uploading';
                        $item.removeClass('upload-success upload-error');
                    }

                    $item.append(`<div class="upload-status ${statusClass}">${statusText}</div>`);

                    // å¦‚æœæ˜¯é”™è¯¯çŠ¶æ€ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
                    if (status === 'error' && errorMsg) {
                        $item.attr('title', `ä¸Šä¼ å¤±è´¥: ${errorMsg}`);
                    }
                }
            });
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        function setupEventListeners() {
            $('#selectImageBtn').on('click', function () {
                $('#fileInput').click();
            });

            // æ–°å¢ï¼šç¡®è®¤ä¸Šä¼ æŒ‰é’®
            $('#confirmUploadBtn').on('click', function () {
                startUpload();
            });

            // æ–°å¢ï¼šå–æ¶ˆä¸Šä¼ æŒ‰é’®
            $('#cancelUploadBtn').on('click', function () {
                cancelUpload();
            });

            $('#refreshBtn').on('click', function () {
                // åˆ·æ–°æ—¶ä¿æŒå½“å‰æœç´¢çŠ¶æ€
                loadImages();
                showToast('å›¾ç‰‡åˆ—è¡¨å·²åˆ·æ–°', 'info');
            });

            $('#prevPage').on('click', function () {
                if (currentPage > 1) {
                    currentPage--;
                    loadImages();
                }
            });

            $('#nextPage').on('click', function () {
                currentPage++;
                loadImages();
            });

            $('#searchBtn').on('click', function () {
                const searchTerm = $('#searchInput').val().trim();
                if (searchTerm.length > 0) {
                    performSearch(searchTerm);
                }
            });
            $('#searchInput').on('keypress', function (e) {
                if (e.which === 13) { // å›è½¦é”®
                    const searchTerm = $(this).val().trim();
                    if (searchTerm.length > 0) {
                        performSearch(searchTerm);
                    }
                }
            });

            $('#searchInput').on('input', function () {
                // å¦‚æœæœç´¢æ¡†ä¸ºç©ºï¼Œæ¸…é™¤æœç´¢
                if ($(this).val().trim() === '') {
                    clearSearch();
                }
            });

            // æ¨¡æ€æ¡†äº‹ä»¶
            $('#modalClose').on('click', function () {
                $('#imageModal').removeClass('show');
            });

            $('#modalDownloadBtn').on('click', function () {
                if (currentPageImages.length > 0 && currentImageIndex >= 0) {
                    const image = currentPageImages[currentImageIndex];
                    const downloadUrl = `/download/${image.filename}`;
                    downloadImage(downloadUrl, image.original_name);
                }
            });

            $('#deleteModalClose, #cancelDelete').on('click', function () {
                $('#deleteModal').removeClass('show');
            });

            $('#confirmDelete').on('click', function () {
                if (currentDeleteFilename) {
                    deleteImage(currentDeleteFilename);
                    $('#deleteModal').removeClass('show');
                }
            });

            // å›¾ç‰‡å¯¼èˆªäº‹ä»¶
            $('#prevImageBtn').on('click', function () {
                navigateImage(-1);
            });

            $('#nextImageBtn').on('click', function () {
                navigateImage(1);
            });

            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            $('.modal').on('click', function (e) {
                if (e.target === this) {
                    $(this).removeClass('show');
                }
            });

            // é”®ç›˜å¯¼èˆªæ”¯æŒ
            $(document).on('keydown', function (e) {
                if ($('#imageModal').hasClass('show')) {
                    if (e.key === 'ArrowLeft') {
                        navigateImage(-1);
                    } else if (e.key === 'ArrowRight') {
                        navigateImage(1);
                    } else if (e.key === 'Escape') {
                        $('#imageModal').removeClass('show');
                    }
                }
            });
        }

        // å¼€å§‹ä¸Šä¼ 
        function startUpload() {
            if (selectedFiles.length === 0 || isUploading) {
                return;
            }

            isUploading = true;

            // ç¦ç”¨æ“ä½œ
            $('#confirmUploadBtn').prop('disabled', true);
            $('#cancelUploadBtn').prop('disabled', true);
            $('#selectImageBtn').prop('disabled', true);
            $('#uploadArea').css('pointer-events', 'none').css('opacity', '0.7');

            // æ˜¾ç¤ºè¿›åº¦æ¡
            $('#progressContainer').show();
            $('#progressStatus').text('å‡†å¤‡ä¸Šä¼ ...');
            $('#progressPercent').text('0%');

            // é‡ç½®ä¸Šä¼ ç®¡ç†å™¨çŠ¶æ€
            uploadManager.reset();

            // å¼€å§‹ä¸Šä¼ 
            uploadManager.addFiles(selectedFiles);
        }

        // å–æ¶ˆä¸Šä¼ 
        function cancelUpload() {
            // é‡ç½®çŠ¶æ€
            resetUploadState();
            showToast('å·²å–æ¶ˆä¸Šä¼ ', 'info');
        }

        // é‡ç½®ä¸Šä¼ çŠ¶æ€
        function resetUploadState() {
            isUploading = false;

            // å¯ç”¨æ“ä½œæŒ‰é’®
            $('#confirmUploadBtn').prop('disabled', false);
            $('#cancelUploadBtn').prop('disabled', false);
            $('#selectImageBtn').prop('disabled', false);
            $('#uploadArea').css('pointer-events', 'auto').css('opacity', '1');

            // éšè—è¿›åº¦æ¡å¹¶é‡ç½®è¿›åº¦
            $('#progressContainer').hide();
            $('#progress').css('width', '0%');
            $('#progressStatus').text('å‡†å¤‡ä¸Šä¼ ...');
            $('#progressPercent').text('0%');

            // é‡ç½®ä¸Šä¼ ç®¡ç†å™¨
            uploadManager.reset();
        }

        // æ‰§è¡Œæœç´¢
        function performSearch(searchTerm) {
            // å–æ¶ˆä¹‹å‰çš„æœç´¢è¯·æ±‚
            if (searchController) {
                searchController.abort();
            }

            currentSearchKeyword = searchTerm;
            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ

            // æ˜¾ç¤ºæœç´¢åŠ è½½çŠ¶æ€
            $('#searchLoading').show();
            $('#galleryGrid').addClass('loading');

            // åˆ›å»ºæ–°çš„AbortController
            searchController = new AbortController();

            loadImages().finally(() => {
                $('#searchLoading').hide();
                $('#galleryGrid').removeClass('loading');
            });
        }

        // è®¾ç½®æ‹–æ”¾åŠŸèƒ½
        function setupDragAndDrop() {
            const $uploadArea = $('#uploadArea');
            const $fileInput = $('#fileInput');

            $uploadArea.on('dragover', function (e) {
                e.preventDefault();
                $(this).addClass('dragover');
            });

            $uploadArea.on('dragleave', function () {
                $(this).removeClass('dragover');
            });

            $uploadArea.on('drop', function (e) {
                e.preventDefault();
                $(this).removeClass('dragover');
                const files = e.originalEvent.dataTransfer.files;
                handleFiles(files);
            });

            $fileInput.on('change', function (e) {
                handleFiles(e.target.files);
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFiles(files) {
            if (files.length === 0) return;

            // å°†æ–°æ–‡ä»¶æ·»åŠ åˆ°å·²é€‰æ–‡ä»¶åˆ—è¡¨
            Array.from(files).forEach(file => {
                // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ–‡ä»¶
                const existingFileIndex = selectedFiles.findIndex(f => f.name === file.name && f.size === file.size);
                if (existingFileIndex === -1) {
                    selectedFiles.push(file);
                }
            });

            // æ›´æ–°æ–‡ä»¶é¢„è§ˆå’ŒçŠ¶æ€
            updateFilePreview();
            updateUploadSummary();

            // æ˜¾ç¤ºä¸Šä¼ æ“ä½œæŒ‰é’®
            if (selectedFiles.length > 0) {
                $('#uploadActions').show();
                $('#uploadSummary').show();
                $('#confirmUploadBtn').prop('disabled', false);
            }
        }

        // æ›´æ–°æ–‡ä»¶é¢„è§ˆ
        function updateFilePreview() {
            const $filePreview = $('#filePreview');
            $filePreview.empty();

            if (selectedFiles.length === 0) {
                $('#uploadActions').hide();
                $('#uploadSummary').hide();
                return;
            }

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const $previewItem = $('<div>', {
                        class: 'file-preview-item'
                    });

                    $previewItem.html(`
                        <img src="${e.target.result}" alt="${file.name}">
                        <button class="remove-btn" data-index="${index}">Ã—</button>
                        <div class="file-name">${file.name}</div>
                    `);

                    $filePreview.append($previewItem);

                    // æ·»åŠ ç§»é™¤æŒ‰é’®äº‹ä»¶
                    $previewItem.find('.remove-btn').on('click', function () {
                        const removeIndex = parseInt($(this).data('index'));
                        selectedFiles.splice(removeIndex, 1);
                        updateFilePreview();
                        updateUploadSummary();

                        // å¦‚æœæ²¡æœ‰æ–‡ä»¶äº†ï¼Œéšè—æ“ä½œæŒ‰é’®
                        if (selectedFiles.length === 0) {
                            $('#uploadActions').hide();
                            $('#uploadSummary').hide();
                        }
                    });
                };
                reader.readAsDataURL(file);
            });
        }

        // æ›´æ–°ä¸Šä¼ æ‘˜è¦ä¿¡æ¯
        function updateUploadSummary() {
            const totalSize = selectedFiles.reduce((sum, file) => sum + file.size, 0);
            $('#fileCount').text(selectedFiles.length);
            $('#totalSize').text(formatFileSize(totalSize));
        }

        // åŠ è½½å›¾ç‰‡åˆ—è¡¨
        async function loadImages() {
            const $galleryGrid = $('#galleryGrid');

            // å¦‚æœå·²ç»æœ‰å›¾ç‰‡ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€ä½†ä¸å®Œå…¨æ¸…ç©ºå†…å®¹
            if ($galleryGrid.children().length > 0 && !$galleryGrid.children().hasClass('loading')) {
                $galleryGrid.addClass('loading');
            } else {
                $galleryGrid.html('<div class="loading">åŠ è½½ä¸­...</div>');
            }

            try {
                // æ ¹æ®æ˜¯å¦æœ‰æœç´¢å…³é”®è¯æ„å»ºä¸åŒçš„URL
                let url = `/images?page=${currentPage}&per_page=${perPage}`;
                if (currentSearchKeyword) {
                    url += `&q=${encodeURIComponent(currentSearchKeyword)}`;
                }

                console.log('Loading URL:', url);

                // ä½¿ç”¨AbortControlleræ¥æ”¯æŒå–æ¶ˆè¯·æ±‚
                const controller = new AbortController();
                const signal = controller.signal;

                // å¦‚æœè¿™æ˜¯æœç´¢è¯·æ±‚ï¼Œä¿å­˜controllerä»¥ä¾¿å–æ¶ˆ
                if (currentSearchKeyword) {
                    searchController = controller;
                }

                const response = await fetch(url, { signal });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                console.log('Loaded data:', data);

                // ä¿å­˜å½“å‰é¡µå›¾ç‰‡æ•°æ®ï¼Œç”¨äºå›¾ç‰‡å¯¼èˆª
                currentPageImages = data.images || [];

                if (!data.images || data.images.length === 0) {
                    // æ ¹æ®æ˜¯å¦æœ‰æœç´¢å…³é”®è¯æ˜¾ç¤ºä¸åŒçš„ç©ºçŠ¶æ€
                    if (currentSearchKeyword) {
                        $galleryGrid.html(`
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ”</div>
                                <h3>æœªæ‰¾åˆ°ç»“æœ</h3>
                                <p>æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${currentSearchKeyword}"çš„å›¾ç‰‡</p>
                                <button class="upload-btn" style="margin-top: 15px;" onclick="clearSearch()">æ¸…é™¤æœç´¢</button>
                            </div>
                        `);
                    } else {
                        $galleryGrid.html(`
                            <div class="empty-state">
                                <div class="empty-state-icon">ğŸ–¼ï¸</div>
                                <h3>æš‚æ— å›¾ç‰‡</h3>
                                <p>ä¸Šä¼ æ‚¨çš„ç¬¬ä¸€å¼ å›¾ç‰‡å¼€å§‹ä½¿ç”¨</p>
                            </div>
                        `);
                    }
                    updatePagination(0);
                    return;
                }

                // ä½¿ç”¨æ·¡å…¥æ•ˆæœæ›´æ–°å†…å®¹
                $galleryGrid.fadeOut(100, function () {
                    $(this).empty();

                    data.images.forEach((image, index) => {
                        const imageCard = createImageCard(image, index);
                        $(this).append(imageCard);
                    });

                    $(this).fadeIn(300);
                });

                // æ›´æ–°åˆ†é¡µä¿¡æ¯ï¼Œå¦‚æœæœ‰æ€»æ•°ä¿¡æ¯ä¹Ÿæ˜¾ç¤º
                if (data.total !== undefined) {
                    updatePagination(data.images.length, data.total, currentSearchKeyword);
                } else {
                    updatePagination(data.images.length);
                }

            } catch (error) {
                // å¦‚æœæ˜¯å–æ¶ˆè¯·æ±‚çš„é”™è¯¯ï¼Œä¸æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                if (error.name === 'AbortError') {
                    console.log('è¯·æ±‚å·²å–æ¶ˆ');
                    return;
                }

                console.error('åŠ è½½å›¾ç‰‡å¤±è´¥:', error);
                $galleryGrid.html(`
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <h3>åŠ è½½å¤±è´¥</h3>
                        <p>${error.message}</p>
                        <button class="upload-btn" style="margin-top: 15px;" onclick="loadImages()">é‡è¯•</button>
                    </div>
                `);
                showToast('åŠ è½½å›¾ç‰‡å¤±è´¥: ' + error.message, 'error');
            } finally {
                $galleryGrid.removeClass('loading');
            }
        }

        // åˆ›å»ºå›¾ç‰‡å¡ç‰‡
        function createImageCard(image, index) {
            const thumbnailUrl = `/thumbnail/${image.filename}`;
            const downloadUrl = `/download/${image.filename}`;

            const $card = $('<div>', {
                class: 'image-card',
                'data-filename': image.filename,
                'data-original-name': image.original_name,
                'data-index': index
            });

            $card.html(`
                <img src="${thumbnailUrl}" alt="${image.original_name}" class="image-thumbnail" loading="lazy">
                <div class="image-info">
                    <div class="image-name" title="${image.original_name}">${image.original_name}</div>
                    <div class="image-meta">
                        <span>${formatFileSize(image.size)}</span>
                        <span>${formatDate(image.upload_time)}</span>
                    </div>
                    <div class="image-actions">
                        <button class="action-btn download-btn">ä¸‹è½½</button>
                        <button class="action-btn delete-btn">åˆ é™¤</button>
                    </div>
                </div>
            `);

            // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            $card.find('.image-thumbnail').on('click', function () {
                viewImage(index);
            });

            $card.find('.download-btn').on('click', function () {
                downloadImage(downloadUrl, image.original_name);
            });

            $card.find('.delete-btn').on('click', function () {
                confirmDeleteImage(image.filename, image.original_name);
            });

            // å¤„ç†å›¾ç‰‡åŠ è½½é”™è¯¯
            $card.find('.image-thumbnail').on('error', function () {
                console.warn('ç¼©ç•¥å›¾åŠ è½½å¤±è´¥:', thumbnailUrl);
                $(this).attr('src', 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjE1MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPua1geWHk+aWh+eroDwvdGV4dD48L3N2Zz4=');
            });

            return $card[0];
        }

        // æŸ¥çœ‹å›¾ç‰‡
        function viewImage(index) {
            currentImageIndex = index;
            updateModalImage();
            $('#imageModal').addClass('show');
        }

        // æ›´æ–°æ¨¡æ€æ¡†ä¸­çš„å›¾ç‰‡
        function updateModalImage() {
            if (currentPageImages.length === 0) return;

            const image = currentPageImages[currentImageIndex];
            const imageUrl = `/uploads/${image.filename}`;

            $('#modalImage').attr('src', imageUrl);
            $('#modalTitle').text(image.original_name);
            $('#imageCounter').text(`${currentImageIndex + 1} / ${currentPageImages.length}`);

            // æ›´æ–°å¯¼èˆªæŒ‰é’®çŠ¶æ€
            $('#prevImageBtn').prop('disabled', currentImageIndex === 0);
            $('#nextImageBtn').prop('disabled', currentImageIndex === currentPageImages.length - 1);
        }

        // å¯¼èˆªå›¾ç‰‡
        function navigateImage(direction) {
            const newIndex = currentImageIndex + direction;

            if (newIndex >= 0 && newIndex < currentPageImages.length) {
                currentImageIndex = newIndex;
                updateModalImage();
            }
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showToast('å¼€å§‹ä¸‹è½½: ' + filename);
        }

        // ç¡®è®¤åˆ é™¤å›¾ç‰‡
        function confirmDeleteImage(filename, originalName) {
            currentDeleteFilename = filename;
            $('#deleteModal').addClass('show');
        }

        // åˆ é™¤å›¾ç‰‡
        async function deleteImage(filename) {
            try {
                const response = await fetch(`/image/${filename}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    showToast('åˆ é™¤æˆåŠŸ');
                    loadImages(); // åˆ·æ–°åˆ—è¡¨

                    // å¦‚æœå½“å‰æŸ¥çœ‹çš„å›¾ç‰‡è¢«åˆ é™¤ï¼Œå…³é—­æ¨¡æ€æ¡†
                    if ($('#imageModal').hasClass('show')) {
                        const currentImage = currentPageImages[currentImageIndex];
                        if (currentImage && currentImage.filename === filename) {
                            $('#imageModal').removeClass('show');
                        }
                    }
                } else {
                    showToast('åˆ é™¤å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('åˆ é™¤é”™è¯¯:', error);
                showToast('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination(itemsCount, total = null, keyword = '') {
            const $prevBtn = $('#prevPage');
            const $nextBtn = $('#nextPage');
            const $pageInfo = $('#pageInfo');

            $prevBtn.prop('disabled', currentPage === 1);

            // å¦‚æœæœ‰æ€»æ•°ï¼Œæ˜¾ç¤ºæ€»æ•°ä¿¡æ¯
            if (total !== null && keyword) {
                $pageInfo.html(`ç¬¬ ${currentPage} é¡µ | å…±æ‰¾åˆ° ${total} ä¸ªç»“æœ`);
            } else if (total !== null && !keyword) {
                $pageInfo.html(`ç¬¬ ${currentPage} é¡µ | å…± ${total} å¼ å›¾ç‰‡`);
            } else {
                $pageInfo.text(`ç¬¬ ${currentPage} é¡µ`);
            }

            $nextBtn.prop('disabled', itemsCount < perPage);
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'success') {
            const $toast = $('#toast');
            const $toastIcon = $toast.find('.toast-icon');
            const $toastMessage = $toast.find('.toast-message');

            // è®¾ç½®å›¾æ ‡å’Œæ¶ˆæ¯
            if (type === 'success') {
                $toastIcon.text('âœ…');
            } else if (type === 'error') {
                $toastIcon.text('âŒ');
            } else {
                $toastIcon.text('â„¹ï¸');
            }

            $toastMessage.text(message);

            // è®¾ç½®æ ·å¼
            $toast.attr('class', `toast ${type} show`);

            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                $toast.removeClass('show');
            }, 3000);
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN');
        }

        // æ¸…é™¤æœç´¢
        function clearSearch() {
            currentSearchKeyword = '';
            $('#searchInput').val('');
            currentPage = 1;
            loadImages();
        }

        // æœç´¢æ—¶çš„é”®ç›˜å¿«æ·é”®æ”¯æŒ
        $(document).on('keydown', function (e) {
            // Ctrl/Cmd + K å¿«é€Ÿèšç„¦æœç´¢æ¡†
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                $('#searchInput').focus();
            }

            // ESC é”®æ¸…é™¤æœç´¢
            if (e.key === 'Escape' && $('#searchInput').is(':focus')) {
                clearSearch();
                $('#searchInput').blur();
            }
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>电影网站</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:'Arial',sans-serif}
        body{background-color:#f5f5f5;color:#333;line-height:1.6}
        .container{max-width:1200px;margin:0 auto;padding:0 15px}
        header{background-color:#1a1a1a;color:white;padding:15px 0;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .header-content{display:flex;justify-content:space-between;align-items:center}
        .logo{font-size:24px;font-weight:bold;color:#e50914}
        .search-bar{display:flex;width:50%}
        .search-bar input{flex:1;padding:8px 12px;border:none;border-radius:4px 0 0 4px}
        .search-bar button{padding:8px 15px;background-color:#e50914;color:white;border:none;border-radius:0 4px 4px 0;cursor:pointer}
        .user-actions{display:flex;align-items:center}
        .user-actions button{background:none;border:1px solid #555;color:white;padding:6px 12px;margin-left:10px;border-radius:4px;cursor:pointer}
        .user-actions button:hover{background-color:#333}
        nav{background-color:#222;padding:10px 0}
        .nav-links{display:flex;list-style:none}
        .nav-links li{margin-right:20px}
        .nav-links a{color:#ddd;text-decoration:none;padding:5px 10px;border-radius:4px}
        .nav-links a:hover,.nav-links a.active{background-color:#333;color:white}
        .main-content{display:flex;margin-top:20px}
        .sidebar{width:200px;margin-right:20px}
        .categories{background-color:white;border-radius:5px;padding:15px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .categories h3{margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid #eee}
        .category-list{list-style:none}
        .category-list li{margin-bottom:8px}
        .category-list a{color:#333;text-decoration:none}
        .category-list a:hover{color:#e50914}
        
        /* 修改电影网格布局为每行一个 */
        .movies-grid{flex:1;display:flex;flex-direction:column;gap:20px}
        .movie-card{background-color:white;border-radius:5px;overflow:hidden;box-shadow:0 2px 5px rgba(0,0,0,0.1);transition:transform 0.3s;display:flex;max-height:200px}
        .movie-card:hover{transform:translateY(-5px)}
        .movie-poster{width:140px;height:200px;object-fit:cover}
        .movie-info{padding:15px;flex:1;display:flex;flex-direction:column;justify-content:space-between}
        .movie-title{font-weight:bold;font-size:18px;margin-bottom:5px}
        .movie-description{color:#666;font-size:14px;margin-bottom:10px;overflow:hidden;display:-webkit-box;-webkit-box-orient:vertical}
        .movie-meta{display:flex;justify-content:space-between;color:#666;font-size:14px}
        .movie-rating{color:#e50914;font-weight:bold}
        
        .pagination{display:flex;justify-content:center;margin:30px 0;list-style:none}
        .pagination li{margin:0 5px}
        .pagination a{display:block;padding:8px 12px;background-color:white;border:1px solid #ddd;border-radius:4px;color:#333;text-decoration:none}
        .pagination a.active,.pagination a:hover{background-color:#e50914;color:white;border-color:#e50914}
        .movie-detail{background-color:white;border-radius:5px;padding:20px;box-shadow:0 2px 5px rgba(0,0,0,0.1)}
        .movie-header{display:flex;margin-bottom:20px}
        .movie-poster-large{width:300px;height:450px;object-fit:cover;border-radius:5px;margin-right:20px}
        .movie-details{flex:1}
        .movie-title-large{font-size:28px;margin-bottom:10px}
        .movie-meta-large{margin-bottom:15px}
        .movie-meta-large span{margin-right:15px;color:#666}
        .movie-description{margin-bottom:20px;line-height:1.8}
        .comments-section{margin-top:30px}
        .comment-form{background-color:#f9f9f9;padding:15px;border-radius:5px;margin-bottom:20px}
        .comment-form textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:4px;margin-bottom:10px;resize:vertical;min-height:80px}
        .comment-form button{background-color:#e50914;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer}
        .comment{display:flex;margin-bottom:20px;padding-bottom:15px;border-bottom:1px solid #eee}
        .user-avatar{width:40px;height:40px;border-radius:50%;margin-right:15px}
        .comment-content{flex:1}
        .comment-header{display:flex;justify-content:space-between;margin-bottom:5px}
        .username{font-weight:bold}
        .comment-date{color:#666;font-size:14px}
        .comment-rating{color:#e50914;font-weight:bold}
        .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);z-index:1000}
        .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background-color:white;padding:30px;border-radius:5px;width:400px;max-width:90%}
        .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
        .close-modal{background:none;border:none;font-size:24px;cursor:pointer}
        .form-group{margin-bottom:15px}
        .form-group label{display:block;margin-bottom:5px}
        .form-group input{width:100%;padding:8px 10px;border:1px solid #ddd;border-radius:4px}
        .form-actions{display:flex;justify-content:space-between;margin-top:20px}
        .btn-primary{background-color:#e50914;color:white;border:none;padding:8px 15px;border-radius:4px;cursor:pointer}
        .btn-secondary{background-color:#f5f5f5;color:#333;border:1px solid #ddd;padding:8px 15px;border-radius:4px;cursor:pointer}
        
        /* 添加返回按钮样式 */
        .back-button {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 15px;
            display: inline-block;
        }
        .back-button:hover {
            background-color: #e9e9e9;
        }
        
        /* 个人中心页面样式 */
        .profile-page {
            background-color: white;
            border-radius: 5px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 20px;
            border: 3px solid #e50914;
            cursor: pointer;
            position: relative;
        }
        .profile-avatar:hover::after {
            content: '点击更换头像';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            font-size: 12px;
        }
        .profile-info h2 {
            margin-bottom: 5px;
        }
        .profile-info p {
            color: #666;
        }
        .profile-form {
            max-width: 600px;
        }
        .profile-form .form-group {
            margin-bottom: 20px;
        }
        .profile-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .profile-form input, .profile-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .profile-form textarea {
            resize: vertical;
            min-height: 100px;
        }
        .avatar-upload {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .avatar-upload input[type="file"] {
            display: none;
        }
        .avatar-upload button {
            background-color: #f5f5f5;
            color: #333;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            width: fit-content;
        }
        .avatar-upload button:hover {
            background-color: #e9e9e9;
        }
        .file-info {
            font-size: 14px;
            color: #666;
        }
        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        @media (max-width:768px){
            .header-content{flex-direction:column;align-items:flex-start}
            .search-bar{width:100%;margin:10px 0}
            .main-content{flex-direction:column}
            .sidebar{width:100%;margin-right:0;margin-bottom:20px}
            .movie-header{flex-direction:column}
            .movie-poster-large{width:100%;margin-right:0;margin-bottom:20px}
            .movie-card{flex-direction:column;max-height:none}
            .movie-poster{width:100%;height:300px}
            .profile-header{flex-direction:column;text-align:center}
            .profile-avatar{margin-right:0;margin-bottom:15px}
        }
    </style>
</head>
<body>
    <!-- 头部 -->
    <header>
        <div class="container header-content">
            <div class="logo">电影网站</div>
            <div class="search-bar">
                <input type="text" id="search-input" placeholder="搜索电影...">
                <button id="search-btn">搜索</button>
            </div>
            <div class="user-actions">
                <button id="login-btn">登录</button>
                <button id="register-btn">注册</button>
                <div id="user-info" style="display: none;">
                    <span id="username-display"></span>
                    <button id="profile-btn">个人中心</button>
                    <button id="logout-btn">退出</button>
                </div>
            </div>
        </div>
    </header>

    <!-- 导航 -->
    <nav>
        <div class="container">
            <ul class="nav-links">
                <li><a href="#" class="nav-link active" data-category="">首页</a></li>
                <li><a href="#" class="nav-link" data-category="1">动作</a></li>
                <li><a href="#" class="nav-link" data-category="2">喜剧</a></li>
                <li><a href="#" class="nav-link" data-category="3">爱情</a></li>
                <li><a href="#" class="nav-link" data-category="4">科幻</a></li>
                <li><a href="#" class="nav-link" data-category="5">恐怖</a></li>
            </ul>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container">
        <div class="main-content">
            <!-- 侧边栏 -->
            <div class="sidebar">
                <div class="categories">
                    <h3>电影分类</h3>
                    <ul class="category-list" id="category-list">
                        <!-- 分类将通过JS动态加载 -->
                    </ul>
                </div>
            </div>

            <!-- 内容区域 -->
            <div class="content-area">
                <!-- 电影列表 -->
                <div id="movies-container">
                    <div class="back-button" id="back-to-movies" style="display: none;">&larr; 返回电影列表</div>
                    <div class="movies-grid" id="movies-grid">
                        <!-- 电影卡片将通过JS动态加载 -->
                    </div>
                    
                    <!-- 分页 -->
                    <ul class="pagination" id="pagination">
                        <!-- 分页将通过JS动态生成 -->
                    </ul>
                </div>
                
                <!-- 电影详情页 -->
                <div id="movie-detail-page" style="display: none;">
                    <div class="back-button" id="back-to-movies-from-detail">&larr; 返回电影列表</div>
                    <div class="movie-detail" id="movie-detail">
                        <!-- 电影详情将通过JS动态加载 -->
                    </div>
                </div>
                
                <!-- 个人中心页面 -->
                <div id="profile-page" style="display: none;">
                    <div class="back-button" id="back-to-movies-from-profile">&larr; 返回电影列表</div>
                    <div class="profile-page">
                        <div class="profile-header">
                            <div class="avatar-container">
                                <img src="./user_avatar_imgs/moren_avatar.jpg" alt="用户头像" class="profile-avatar" id="profile-avatar">
                            </div>
                            <div class="profile-info">
                                <h2 id="profile-username">用户名</h2>
                                <p id="profile-email">邮箱</p>
                                <p id="profile-join-date">注册日期</p>
                            </div>
                        </div>
                        
                        <form id="profile-form" class="profile-form">
                            <div class="form-group">
                                <label for="edit-username">用户名</label>
                                <input type="text" id="edit-username" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="edit-email">邮箱</label>
                                <input type="email" id="edit-email" required>
                            </div>
                            
                            <div class="form-group">
                                <label>头像上传</label>
                                <div class="avatar-upload">
                                    <input type="file" id="avatar-file" accept="image/*">
                                    <button type="button" id="avatar-upload-btn">选择图片文件</button>
                                    <div class="file-info" id="file-info">支持 JPG, PNG 格式，最大 10MB</div>
                                    <div class="avatar-preview">
                                        <span>预览:</span>
                                        <img src="" alt="头像预览" id="avatar-preview" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-left: 10px; border: 2px solid #ddd;">
                                    </div>
                                </div>
                            </div>
                            
                            
                            <div class="form-group">
                                <label for="current-password">当前密码（修改信息时需要）</label>
                                <input type="password" id="current-password">
                            </div>
                            
                            <div class="form-group">
                                <label for="new-password">新密码（留空则不修改）</label>
                                <input type="password" id="new-password">
                            </div>
                            
                            <div class="profile-actions">
                                <button type="submit" class="btn-primary">保存更改</button>
                                <button type="button" class="btn-secondary" id="cancel-edit">取消</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 登录模态框 -->
    <div class="modal" id="login-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>用户登录</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="login-form">
                <div class="form-group">
                    <label for="login-email">邮箱</label>
                    <input type="email" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">密码</label>
                    <input type="password" id="login-password" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="switch-to-register">没有账号？去注册</button>
                    <button type="submit" class="btn-primary">登录</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div class="modal" id="register-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>用户注册</h2>
                <button class="close-modal">&times;</button>
            </div>
            <form id="register-form">
                <div class="form-group">
                    <label for="register-username">用户名</label>
                    <input type="text" id="register-username" required>
                </div>
                <div class="form-group">
                    <label for="register-email">邮箱</label>
                    <input type="email" id="register-email" required>
                </div>
                <div class="form-group">
                    <label for="register-password">密码</label>
                    <input type="password" id="register-password" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="switch-to-login">已有账号？去登录</button>
                    <button type="submit" class="btn-primary">注册</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // API基础URL - 请根据实际后端地址修改
        const currentHost = window.location.hostname;
        const API_BASE_URL = `http://${currentHost}:8150`;
        
        // 全局状态
        let currentPage = 1;
        let currentCategory = '';
        let currentSearch = '';
        let currentOrderBy = 'rating';
        let currentOrder = 'desc';
        let token = localStorage.getItem('token');
        let currentUser = null;
        let selectedAvatarFile = null;
        
        // DOM加载完成后初始化
        $(document).ready(function() {
            // 初始化页面
            loadCategories();
            loadMovies();
            checkAuthStatus();
            
            // 事件绑定
            $('#search-btn').click(handleSearch);
            $('#search-input').keypress(function(e) {
                if (e.which === 13) {
                    handleSearch();
                }
            });
            
            $('.nav-link').click(function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                currentCategory = $(this).data('category');
                currentPage = 1;
                // 点击导航时返回电影列表
                backToMovies();
                loadMovies();
            });
            
            // 返回按钮事件
            $('#back-to-movies, #back-to-movies-from-detail, #back-to-movies-from-profile').click(function() {
                backToMovies();
            });
            
            $('#login-btn').click(function() {
                $('#login-modal').show();
            });
            
            $('#register-btn').click(function() {
                $('#register-modal').show();
            });
            
            $('#profile-btn').click(function() {
                showProfilePage();
            });
            
            $('#switch-to-register').click(function() {
                $('#login-modal').hide();
                $('#register-modal').show();
            });
            
            $('#switch-to-login').click(function() {
                $('#register-modal').hide();
                $('#login-modal').show();
            });
            
            $('.close-modal').click(function() {
                $('#login-modal').hide();
                $('#register-modal').hide();
            });
            
            $('#logout-btn').click(function() {
                localStorage.removeItem('token');
                token = null;
                currentUser = null;
                checkAuthStatus();
                backToMovies();
            });
            
            $('#login-form').submit(function(e) {
                e.preventDefault();
                loginUser();
            });
            
            $('#register-form').submit(function(e) {
                e.preventDefault();
                registerUser();
            });
            
            $('#profile-form').submit(function(e) {
                e.preventDefault();
                updateProfile();
            });
            
            $('#cancel-edit').click(function() {
                backToMovies();
            });
            
            // 头像上传相关事件
            $('#profile-avatar').click(function() {
                $('#avatar-file').click();
            });
            
            $('#avatar-upload-btn').click(function() {
                $('#avatar-file').click();
            });
            
            $('#avatar-file').change(function(e) {
                handleAvatarFileSelect(e);
            });
            
            // 点击模态框外部关闭
            $(window).click(function(e) {
                if ($(e.target).hasClass('modal')) {
                    $('.modal').hide();
                }
            });
        });
        
        // 加载分类列表
        function loadCategories() {
            $.ajax({
                url: `${API_BASE_URL}/categories`,
                method: 'GET',
                success: function(categories) {
                    let categoryHtml = '';
                    categories.forEach(category => {
                        categoryHtml += `<li><a href="#" class="category-link" data-id="${category.id}">${category.name}</a></li>`;
                    });
                    $('#category-list').html(categoryHtml);
                    
                    // 绑定分类点击事件
                    $('.category-link').click(function(e) {
                        e.preventDefault();
                        currentCategory = $(this).data('id');
                        currentPage = 1;
                        // 点击分类时返回电影列表
                        backToMovies();
                        loadMovies();
                    });
                },
                error: function(xhr, status, error) {
                    console.error('加载分类失败:', error);
                }
            });
        }
        
        // 加载电影列表
        function loadMovies() {
            let url = `${API_BASE_URL}/movies/?page=${currentPage}&size=20`;
            
            if (currentCategory) {
                url += `&category=${currentCategory}`;
            }
            
            if (currentSearch) {
                url += `&search=${encodeURIComponent(currentSearch)}`;
            }
            
            url += `&order_by=${currentOrderBy}&order=${currentOrder}`;
            
            $.ajax({
                url: url,
                method: 'GET',
                success: function(response) {
                    displayMovies(response.movies);
                    displayPagination(response.total, response.page, response.size);
                },
                error: function(xhr, status, error) {
                    console.error('加载电影失败:', error);
                }
            });
        }
        
        // 显示电影列表
        function displayMovies(movies) {
            let moviesHtml = '';
            
            if (movies.length === 0) {
                moviesHtml = '<p>没有找到相关电影</p>';
            } else {
                movies.forEach(movie => {
                    moviesHtml += `
                        <div class="movie-card" data-id="${movie.id}">
                            <img src="${movie.cover_url || 'https://via.placeholder.com/200x280?text=No+Image'}" 
                                 alt="${movie.title}" class="movie-poster">
                            <div class="movie-info">
                                <div class="movie-title">${movie.title}</div>
                                <div class="movie-description">${movie.plot || movie.description || '暂无简介'}</div>
                                <div class="movie-meta">
                                    <span>${movie.release_year}</span>
                                    <span class="movie-rating">${movie.rating || '无评分'}</span>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            $('#movies-grid').html(moviesHtml);
            
            // 绑定电影点击事件
            $('.movie-card').click(function() {
                const movieId = $(this).data('id');
                showMovieDetail(movieId);
            });
        }
        
        // 显示分页
        function displayPagination(total, page, size) {
            const totalPages = Math.ceil(total / size);
            let paginationHtml = '';
            
            if (totalPages > 1) {
                // 上一页
                if (page > 1) {
                    paginationHtml += `<li><a href="#" class="page-link" data-page="${page - 1}">上一页</a></li>`;
                }
                
                // 页码
                for (let i = 1; i <= totalPages; i++) {
                    if (i === page) {
                        paginationHtml += `<li><a href="#" class="page-link active" data-page="${i}">${i}</a></li>`;
                    } else {
                        paginationHtml += `<li><a href="#" class="page-link" data-page="${i}">${i}</a></li>`;
                    }
                }
                
                // 下一页
                if (page < totalPages) {
                    paginationHtml += `<li><a href="#" class="page-link" data-page="${page + 1}">下一页</a></li>`;
                }
            }
            
            $('#pagination').html(paginationHtml);
            
            // 绑定分页点击事件
            $('.page-link').click(function(e) {
                e.preventDefault();
                currentPage = $(this).data('page');
                loadMovies();
            });
        }
        
        // 显示电影详情
        function showMovieDetail(movieId) {
            $.ajax({
                url: `${API_BASE_URL}/movies/${movieId}`,
                method: 'GET',
                success: function(movie) {
                    let categoriesHtml = '';
                    if (movie.categories && movie.categories.length > 0) {
                        categoriesHtml = movie.categories.map(cat => cat.name).join(', ');
                    }
                    
                    let commentsHtml = '';
                    if (movie.comments && movie.comments.length > 0) {
                        movie.comments.forEach(comment => {
                            commentsHtml += `
                                <div class="comment">
                                    <img src="${comment.avatar_url || 'https://via.placeholder.com/40x40?text=U'}" 
                                         alt="${comment.username}" class="user-avatar">
                                    <div class="comment-content">
                                        <div class="comment-header">
                                            <span class="username">${comment.username}</span>
                                            <div>
                                                <span class="comment-rating">${comment.rating || '无评分'}</span>
                                                <span class="comment-date">${formatDate(comment.created_at)}</span>
                                            </div>
                                        </div>
                                        <div class="comment-text">${comment.content}</div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        commentsHtml = '<p>暂无评论</p>';
                    }
                    
                    const movieDetailHtml = `
                        <div class="movie-header">
                            <img src="${movie.cover_url || 'https://via.placeholder.com/300x450?text=No+Image'}" 
                                 alt="${movie.title}" class="movie-poster-large">
                            <div class="movie-details">
                                <h1 class="movie-title-large">${movie.title}</h1>
                                <div class="movie-meta-large">
                                    <span>${movie.release_year}</span>
                                    <span>${movie.duration}分钟</span>
                                    <span>${movie.country}</span>
                                    <span class="movie-rating">评分: ${movie.rating || '无'}</span>
                                </div>
                                <div class="movie-meta-large">
                                    <span>导演: ${movie.director || '未知'}</span>
                                </div>
                                <div class="movie-meta-large">
                                    <span>主演: ${movie.actors || '未知'}</span>
                                </div>
                                <div class="movie-meta-large">
                                    <span>分类: ${categoriesHtml}</span>
                                </div>
                                <div class="movie-description">
                                    <h3>剧情简介</h3>
                                    <p>${movie.plot || movie.description || '暂无简介'}</p>
                                </div>
                            </div>
                        </div>
                        <div class="comments-section">
                            <h3>用户评论</h3>
                            ${currentUser ? `
                                <div class="comment-form">
                                    <textarea id="comment-content" placeholder="写下你的评论..."></textarea>
                                    <div>
                                        <span>评分: </span>
                                        <select id="comment-rating">
                                            <option value="">不评分</option>
                                            <option value="1">1分</option>
                                            <option value="2">2分</option>
                                            <option value="3">3分</option>
                                            <option value="4">4分</option>
                                            <option value="5">5分</option>
                                            <option value="6">6分</option>
                                            <option value="7">7分</option>
                                            <option value="8">8分</option>
                                            <option value="9">9分</option>
                                            <option value="10">10分</option>
                                        </select>
                                        <button id="submit-comment" data-movie-id="${movie.id}">提交评论</button>
                                    </div>
                                </div>
                            ` : '<p>请登录后发表评论</p>'}
                            <div id="comments-list">
                                ${commentsHtml}
                            </div>
                        </div>
                    `;
                    
                    $('#movie-detail').html(movieDetailHtml);
                    $('#movies-container').hide();
                    $('#movie-detail-page').show();
                    $('#profile-page').hide();
                    
                    // 绑定提交评论事件
                    $('#submit-comment').click(function() {
                        submitComment(movie.id);
                    });
                },
                error: function(xhr, status, error) {
                    console.error('加载电影详情失败:', error);
                }
            });
        }
        
        // 显示个人中心页面
        function showProfilePage() {
            if (!currentUser) {
                alert('请先登录');
                return;
            }
            
            // 隐藏其他页面，显示个人中心
            $('#movies-container').hide();
            $('#movie-detail-page').hide();
            $('#profile-page').show();
            
            // 填充用户信息
            $('#profile-username').text(currentUser.username);
            $('#profile-email').text(currentUser.email);
            $('#profile-join-date').text(`注册于: ${formatDate(currentUser.created_at)}`);
            
            // 设置头像
            const avatarUrl = currentUser.avatar_url || './user_avatar_imgs/moren_avatar.jpg';
            $('#profile-avatar').attr('src', avatarUrl);
            $('#avatar-preview').attr('src', avatarUrl);
            
            // 填充表单
            $('#edit-username').val(currentUser.username);
            $('#edit-email').val(currentUser.email);
            $('#edit-bio').val(currentUser.bio || '');
            
            // 重置文件选择
            $('#avatar-file').val('');
            selectedAvatarFile = null;
            $('#file-info').text('支持 JPG, PNG 格式，最大 10MB');
        }
        
        // 处理头像文件选择
        function handleAvatarFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.match('image.*')) {
                alert('请选择图片文件（JPG、PNG等）');
                return;
            }
            
            // 检查文件大小（10MB = 10 * 1024 * 1024 bytes）
            if (file.size > 10 * 1024 * 1024) {
                alert('文件大小不能超过 10MB');
                return;
            }
            
            selectedAvatarFile = file;
            $('#file-info').text(`已选择: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            // 预览图片
            const reader = new FileReader();
            reader.onload = function(e) {
                $('#avatar-preview').attr('src', e.target.result);
            };
            reader.readAsDataURL(file);
        }
        
        // 更新用户信息
        function updateProfile() {
            const username = $('#edit-username').val();
            const email = $('#edit-email').val();
            const currentPassword = $('#current-password').val();
            const newPassword = $('#new-password').val();
            
            // 构建更新数据
            const updateData = {
                username: username,
                email: email,
            };
            
            // 如果有新密码，需要验证当前密码
            if (newPassword) {
                if (!currentPassword) {
                    alert('修改密码需要输入当前密码');
                    return;
                }
                updateData.current_password = currentPassword;
                updateData.new_password = newPassword;
            } else if (currentPassword) {
                // 如果只输入了当前密码但没有新密码，也需要验证
                updateData.current_password = currentPassword;
            }
            
            // 如果有头像文件，先上传头像
            if (selectedAvatarFile) {
                uploadAvatar(selectedAvatarFile).then(avatarUrl => {
                    // 头像上传成功后，更新用户信息
                    updateData.avatar_url = avatarUrl;
                    sendProfileUpdate(updateData);
                }).catch(error => {
                    alert('头像上传失败: ' + error);
                });
            } else {
                // 没有新头像，直接更新用户信息
                sendProfileUpdate(updateData);
            }
        }
        
        // 上传头像
        function uploadAvatar(file) {
            return new Promise((resolve, reject) => {
                const formData = new FormData();
                formData.append('avatar', file);
                
                $.ajax({
                    url: `${API_BASE_URL}/users/me/avatar`,
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(response) {
                        resolve(response.avatar_url);
                    },
                    error: function(xhr, status, error) {
                        reject(xhr.responseJSON?.detail || '未知错误');
                    }
                });
            });
        }
        
        // 发送用户信息更新请求
        function sendProfileUpdate(updateData) {
            $.ajax({
                url: `${API_BASE_URL}/users/me`,
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify(updateData),
                success: function(response) {
                    currentUser = response.updatedUser;
                    alert('个人信息更新成功');
                    // 更新token
                    if (response.token) {
                        token = response.token;
                        localStorage.setItem('token', token);
                    }
                    
                    checkAuthStatus(); // 更新显示的用户名
                    showProfilePage(); // 刷新个人中心页面
                    
                },
                error: function(xhr, status, error) {
                    alert('更新失败: ' + (xhr.responseJSON?.detail || '未知错误'));
                }
            });
        }
        
        // 返回电影列表
        function backToMovies() {
            $('#movie-detail-page').hide();
            $('#profile-page').hide();
            $('#movies-container').show();
        }
        
        // 处理搜索
        function handleSearch() {
            currentSearch = $('#search-input').val();
            currentPage = 1;
            // 搜索时返回电影列表
            backToMovies();
            loadMovies();
        }
        
        // 用户登录
        function loginUser() {
            const email = $('#login-email').val();
            const password = $('#login-password').val();
            
            $.ajax({
                url: `${API_BASE_URL}/auth/login`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    email: email,
                    password: password
                }),
                success: function(response) {
                    token = response.token;
                    localStorage.setItem('token', token);
                    currentUser = {
                        id: response.id,
                        username: response.username,
                        email: response.email,
                        avatar_url: response.avatar_url,
                        bio: response.bio,
                        created_at: response.created_at
                    };
                    
                    $('#login-modal').hide();
                    checkAuthStatus();
                    $('#login-form')[0].reset();
                    backToMovies(); // 登录后返回电影列表
                },
                error: function(xhr, status, error) {
                    alert('登录失败: ' + (xhr.responseJSON?.detail || '未知错误'));
                }
            });
        }
        
        // 用户注册
        function registerUser() {
            const username = $('#register-username').val();
            const email = $('#register-email').val();
            const password = $('#register-password').val();
            
            $.ajax({
                url: `${API_BASE_URL}/auth/register`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    username: username,
                    email: email,
                    password: password
                }),
                success: function(response) {
                    token = response.token;
                    localStorage.setItem('token', token);
                    currentUser = {
                        id: response.id,
                        username: response.username,
                        email: response.email,
                        avatar_url: response.avatar_url,
                        bio: response.bio,
                        created_at: response.created_at
                    };
                    
                    $('#register-modal').hide();
                    checkAuthStatus();
                    $('#register-form')[0].reset();
                    backToMovies(); // 注册后返回电影列表
                },
                error: function(xhr, status, error) {
                    alert('注册失败: ' + (xhr.responseJSON?.detail || '未知错误'));
                }
            });
        }
        
        // 检查认证状态
        function checkAuthStatus() {
            if (token) {
                // 获取用户信息
                $.ajax({
                    url: `${API_BASE_URL}/users/me`,
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    success: function(user) {
                        currentUser = user;
                        $('#user-info').show();
                        $('#username-display').text(user.username);
                        $('#login-btn, #register-btn').hide();
                    },
                    error: function() {
                        // token无效
                        localStorage.removeItem('token');
                        token = null;
                        currentUser = null;
                        $('#user-info').hide();
                        $('#login-btn, #register-btn').show();
                    }
                });
            } else {
                $('#user-info').hide();
                $('#login-btn, #register-btn').show();
            }
        }
        
        // 提交评论
        function submitComment(movieId) {
            const content = $('#comment-content').val();
            const rating = $('#comment-rating').val();
            
            if (!content.trim()) {
                alert('评论内容不能为空');
                return;
            }
            
            $.ajax({
                url: `${API_BASE_URL}/comments`,
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                data: JSON.stringify({
                    movie_id: movieId,
                    content: content,
                    rating: rating ? parseFloat(rating) : null
                }),
                success: function(comment) {
                    // 重新加载电影详情以显示新评论
                    showMovieDetail(movieId);
                },
                error: function(xhr, status, error) {
                    alert('提交评论失败: ' + (xhr.responseJSON?.detail || '未知错误'));
                }
            });
        }
        
        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>